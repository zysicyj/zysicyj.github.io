<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MySQL高可用搭建方案之（MMM） | </title><meta name="author" content="程序员朱永胜"><meta name="copyright" content="程序员朱永胜"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="有的时候博客内容会有变动，首发博客是最新的，其他博客地址可能会未同步,认准https:&amp;#x2F;&amp;#x2F;blog.zysicyj.top   注意：这篇转载文章，非原创  首发博客地址 面试题手册 原文地址前言MySQL的高可用有很多种，有我们经常说的MMM架构、MHA架构、MGR架构。在这一篇文章中我们先讨论"><link rel="shortcut icon" href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/aliyun/202308012321669.jpg"><link rel="canonical" href="https://zysicyj.github.io/mysql_mmm.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?16bc6435aa26c2ae803ad0e62e4f5fa8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 程序员朱永胜","link":"链接: ","source":"来源: ","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL高可用搭建方案之（MMM）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-26 22:18:52'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 20
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="atom.xml" title="" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/aliyun/202308012321669.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="../archives/"><div class="headline">文章</div><div class="length-num">240</div></a><a href="../tags/"><div class="headline">标签</div><div class="length-num">974</div></a><a href="../categories/"><div class="headline">分类</div><div class="length-num">61</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="../index.html"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="../today"><i class="fa-fw fas fa-solid fa-calendar-week"></i><span> Today</span></a></div><div class="menus_item"><a class="site-page" href="../shuoshuo/"><i class="fa-fw fas fa-solid fa-newspaper"></i><span> 公告</span></a></div><div class="menus_item"><a class="site-page" href="../gallery/"><i class="fa-fw fas fa-solid fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="../lyb/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="../rp.html"><i class="fa-fw fas fa-comment-dots"></i><span> 锐评</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-link"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="../archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="../tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="../categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="../movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="../books/"><i class="fa-fw fas fa-book"></i><span> 阅读</span></a></li><li><a class="site-page child" href="../songs/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="../link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="../love/static/index.html"><i class="fa-fw fas fa-heart"></i><span> Love</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img.xjh.me/random_img.php?return=302')"><nav id="nav"><span id="blog-info"><a href="../index.html" title=""><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/aliyun/202308012321669.jpg"/><span class="site-name"></span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="../index.html"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="../today"><i class="fa-fw fas fa-solid fa-calendar-week"></i><span> Today</span></a></div><div class="menus_item"><a class="site-page" href="../shuoshuo/"><i class="fa-fw fas fa-solid fa-newspaper"></i><span> 公告</span></a></div><div class="menus_item"><a class="site-page" href="../gallery/"><i class="fa-fw fas fa-solid fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="../lyb/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="../rp.html"><i class="fa-fw fas fa-comment-dots"></i><span> 锐评</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-link"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="../archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="../tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="../categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="../movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="../books/"><i class="fa-fw fas fa-book"></i><span> 阅读</span></a></li><li><a class="site-page child" href="../songs/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="../link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="../love/static/index.html"><i class="fa-fw fas fa-heart"></i><span> Love</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL高可用搭建方案之（MMM）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-10T08:48:40.000Z" title="发表于 2023-09-10 16:48:40">2023-09-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-26T14:18:52.342Z" title="更新于 2023-09-26 22:18:52">2023-09-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>54分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL高可用搭建方案之（MMM）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><link rel="stylesheet external nofollow noreferrer" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><blockquote>
<p>有的时候博客内容会有变动，首发博客是最新的，其他博客地址可能会未同步,认准<code>https://blog.zysicyj.top</code></p>
</blockquote>
<blockquote>
<p>注意：这篇转载文章，非原创</p>
</blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.zysicyj.top/">首发博客地址</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://store.amazingmemo.com/chapterDetail/1685324709017001">面试题手册</a></p>
<h2 id="原文地址"><a href="#原文地址" class="headerlink" title="原文地址"></a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.modb.pro/db/74005">原文地址</a></h2><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL的高可用有很多种，有我们经常说的MMM架构、MHA架构、MGR架构。在这一篇文章中我们先讨论MMM架构的高可用，后续在分析MHA和MGR，其中的MGR有点类似于percona推出的PXC集群</p>
<h2 id="集群-VS-高可用"><a href="#集群-VS-高可用" class="headerlink" title="集群 VS 高可用"></a>集群 VS 高可用</h2><p>在MySQL数据库中，什么是集群？什么是高可用？最早我理解的是只要有了读写分离的组从集群架构，就是拥有高可用的架构了。现在想想，当初的想法是多么的天真。MySQL集群和MySQL的高可用是两个概念，我们不能把他们混为一谈。</p>
<p>集群是指你多台MySQL数据库实例，有一个可以提供写，多个提供读、或者有多个可以写，多个可以读。比如我们配置了读写分离的一主多从的集群架构，或者双主多从的集群架构。此时，我们只是有了MySQL的集群，在读写性能上有锁提升，但是此时并不是一个高可用的MySQL架构。</p>
<p>高可用是指在任意一个时刻，我们的MySQL都可以提供读写的服务，不会因为某一个MySQL数据库实例宕机而导致MySQL数据不能正常读写，此时才是高可用。从某种意义上来说，高可用要在集群的基础上才可以实现，也就是说，要想高可用，必须先把集群搭建起来。有了MySQL的集群，才可以谈论MySQL的高可用，没有MySQL的集群，谈MySQL的高可用犹如空中楼阁。</p>
<p>拿我们前面说的双主多从的MySQL集群架构来说，两个主在同一个时间点，若只有一个主对外提供写的服务，此时如果其中一个主宕机，另外一个主可以顶替原先的主对外提供写的服务，同时其他的从可以把同步的数据源切换到新的主上面来，这样的一个集群就是一个高可用的架构。</p>
<p>有了MySQL的集群，并不一定就有MySQL的高可用。但是如果有了MySQL的高可用，那么此时它一定是一个MySQL集群。高可用需要在集群的基础上来配合其他组件才能实现。</p>
<h2 id="MMM高可用架构"><a href="#MMM高可用架构" class="headerlink" title="MMM高可用架构"></a>MMM高可用架构</h2><h3 id="什么是MMM"><a href="#什么是MMM" class="headerlink" title="什么是MMM"></a>什么是MMM</h3><p>所谓的MMM只是：<strong>M</strong>ulti-<strong>M</strong>aster Replication <strong>M</strong>anager for<br>MySQL，取其中的三个M开头的单词简写。它是mysql多主复制管理器，基于perl实现，关于mysql主主复制配置的监控、故障转移和管理的一套可伸缩的脚本套件（在任何时候只有一个节点可以被写入），MMM也能对从服务器进行读负载均衡，所以可以用它来在一组用于复制的服务器启动虚拟ip，除此之外，它还有实现数<br>据备份、节点之间重新同步功能的脚本。</p>
<p>MySQL本身没有提供replication failover的解决方案，通过MMM方案<br>能实现服务器的故障转移，从而实现mysql的高可用。MMM不仅能提供浮动IP的功能，如果当前的主服务器挂掉后，会将你后端的从服务器自动转向新的主服务器进行同步复制，不用手工更改同步配置。</p>
<p>从字面来理解就是它有两个master节点，并且实现了这两个master节点的高可用。它的架构如下所示：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62153149517400.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62153149517400.png"></a></p>
<p>MMM主要功能，由下面三个脚本提供：</p>
<ul>
<li><p>mmm_mond 负责所有的监控工作的监控守护进程，决定节点的移除(mmm_mond进程定 时心跳检测，失败则将write<br>ip浮动到另外一台master)</p>
</li>
<li><p>mmm_agentd 运行在mysql服务器上的代理守护进 程，通过简单远程服务集提供给监控节点</p>
</li>
<li><p>mmm_control 通过命令行管理mmm_mond进程 在整个监管过程中，<br>需要在mysql中添加相关授权用户，授权的用户包括一个mmm_monitor用户和一个mmm_agent用户，如果想使用mmm的备份工具则还要添加一个mmm_tools用户。</p>
</li>
</ul>
<h3 id="MMM架构的优点"><a href="#MMM架构的优点" class="headerlink" title="MMM架构的优点"></a>MMM架构的优点</h3><ul>
<li><p>可以兼容不同系列的MySQL来做高可用。比如有MySQL官方社区版本，有percona版本的，有MariaDB版本的MySQL。这样的集群可以可以使用MMM架构来做高可用。</p>
</li>
<li><p>高可用性，扩展性好，出现故障自动切换，对于主主同步，在同一时间只提供一台数据库写操作，保证 的数据的一致性。</p>
</li>
<li><p>当主服务器挂掉以后，另一个主立即接管，其他的从服务器能自动切换，不用人工干预。</p>
</li>
</ul>
<h3 id="MMM架构的缺点"><a href="#MMM架构的缺点" class="headerlink" title="MMM架构的缺点"></a>MMM架构的缺点</h3><ul>
<li><p>是一种比较老的MySQL高可用实现方式，因为社区不活跃，所以目前已经没有人在维护这个组件了。</p>
</li>
<li><p>只能基于日之点的主从复制集群架构来做高可用，不支持基于GTID的主从复制集群架构。这也是因为社区活跃，没有维护这个组件导致不支持GTID。</p>
</li>
<li><p>数据不能保证100%的一致性，这个是以为它在做故障转移的时候实现的方式所导致的。如果对于数据需要强一致性，则不能选择MMM高可用架构，可以考虑MHA高可用架构。</p>
</li>
<li><p>monitor节点是单点，不过这个可以结合keepalived或者haertbeat做成高可用。</p>
</li>
<li><p>至少三个节点，2个master，1个slave，对主机的数量有要求，</p>
</li>
<li><p>在读写非常繁忙的业务系统下表现不是很稳定，可能会出现复制延时、切换失效等问题。</p>
</li>
<li><p>MMM方案并不太适应于对数据安全性要求很高，并且读、写 繁忙的环境中。</p>
</li>
<li><p>需要实现读写分离，还需要在前端编写读写分离程序，或者结合数据库中间件如mycat来解决。</p>
</li>
</ul>
<h2 id="如何搭建MMM高可用架构"><a href="#如何搭建MMM高可用架构" class="headerlink" title="如何搭建MMM高可用架构"></a>如何搭建MMM高可用架构</h2><p>要想实现MMM高可用架构，我们先来搭建一个双主双从的MySQL集群，然后在这个集群的基础上来完成MMM高可用的架构。</p>
<p>我们准备搭建的MySQL-MMM高可用架构的网络拓扑如下所示：需要注意的是其中的VIP，这几个IP不需要我们自己创建，MMM服务会自动的在各个节点分配这些VIP。其中的绿色字体read<br>vip，它并不会严格的按照我们下图中分配是主机来分配，而是随机的将这4个read vip分布到4个数据库节点上，但是红色字体的write<br>vip只会在master1或master2上面随着master1和master2节点宕机和恢复来回切换。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62165973507400.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62165973507400.png"></a></p>
<h3 id="搭建双主双从的MySQL集群"><a href="#搭建双主双从的MySQL集群" class="headerlink" title="搭建双主双从的MySQL集群"></a>搭建双主双从的MySQL集群</h3><h4 id="准备MySQL数据库环境"><a href="#准备MySQL数据库环境" class="headerlink" title="准备MySQL数据库环境"></a>准备MySQL数据库环境</h4><p>我们使用docker来启动4个MySQL容器，作为双主双从的四个MySQL数据库实例。容器镜像的名称为<code>mysql:5.7.31</code><br>，这个镜像是docker hub上面MySQL官方提供的镜像，它是基于<code>Debian buster</code><br>版本制作的MySQL容器镜像。所以，我们的MySQL数据库服务器，可以任务是一个minimal版本的Debian系统。</p>
<p>为了方便管理，我们先创建一个docker虚拟网段，然后在启动四个MySQL数据库的时候，指定数据库服务器的IP地址并且使用这个网段。创建网段的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.20.0.0/24 mysql-ha-mmm-network</span><br><span class="line"></span><br><span class="line">我们使用下面的四条命令，启动4个MySQL数据库实例。这里我们把每一个数据库的`my.cnf`  </span><br><span class="line">配置文件已经在本地配置好，然后通过数据卷的方式挂载到MySQL容器中，这样我们启动的MySQL数据库实例就会按照我们配置的`my.cnf`  </span><br><span class="line">配置文件来启动并配置我们的MySQL数据库实例。</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动master1节点</span>  </span><br><span class="line">docker run --net=mysql-ha-mmm-network --hostname master1.mysql --ip 172.20.0.11 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-master1 -d -v Users/coder-home/docker\_mysql\_ha/mmm/master1:/etc/mysql/conf.d -e MYSQL\_ROOT_PASSWORD=root</span><br><span class="line">-e TZ=&quot;Asia/Shanghai&quot; -p 33011:3306 mysql:5.7.31</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动slave1节点</span>  </span><br><span class="line">docker run --net=mysql-ha-mmm-network --hostname slave1.mysql --ip 172.20.0.12 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-slave1 -d -v Users/coder-home/docker\_mysql\_ha/mmm/slave1:/etc/mysql/conf.d -e MYSQL\_ROOT_PASSWORD=root</span><br><span class="line">-e TZ=&quot;Asia/Shanghai&quot; -p 33012:3306 mysql:5.7.31</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动master2节点</span>  </span><br><span class="line">docker run --net=mysql-ha-mmm-network --hostname master2.mysql --ip 172.20.0.21 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-master2 -d -v Users/coder-home/docker\_mysql\_ha/mmm/master2:/etc/mysql/conf.d -e MYSQL\_ROOT_PASSWORD=root</span><br><span class="line">-e TZ=&quot;Asia/Shanghai&quot; -p 33021:3306 mysql:5.7.31</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动slave2节点</span>  </span><br><span class="line">docker run --net=mysql-ha-mmm-network --hostname slave2.mysql --ip 172.20.0.22 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-slave2 -d -v Users/coder-home/docker\_mysql\_ha/mmm/slave2:/etc/mysql/conf.d -e MYSQL\_ROOT_PASSWORD=root</span><br><span class="line">-e TZ=&quot;Asia/Shanghai&quot; -p 33022:3306 mysql:5.7.31</span><br></pre></td></tr></table></figure>

<p>这里解释一下<code>docker run</code><br>后面几个重要的参数和含义。</p>
<ul>
<li><p>–net&#x3D;mysql-ha-mmm-network：指定容器运行的时候使用的网段。</p>
</li>
<li><p>–hostname slave2.mysql：指定容器的主机名称。</p>
</li>
<li><p>–ip 172.20.0.22：指定容器使用的IP地址。</p>
</li>
<li><p>–cap-add NET_ADMIN：默认容器运行的时候，没有增加额外的Linux的功能，这里我们要增加上NET_ADMIN的功能，否则我们不能再启动后的容器内使用ifconfig命令增加虚拟IP。否则会有如下错误提示：</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@test:/etc/network# ifconfig eth0:0 192.168.1.100 up  </span><br><span class="line">SIOCSIFADDR: Operation not permitted  </span><br><span class="line">SIOCSIFFLAGS: Operation not permitted  </span><br><span class="line">SIOCSIFFLAGS: Operation not permitted  </span><br><span class="line">root@test:/etc/network#</span><br></pre></td></tr></table></figure>

<ul>
<li><p>–name mysql-ha-mmm-slave2：指定容器的名称为<code>mysql-ha-mmm-slave2</code><br>，后面我们在停止或重启容器的时候，可以通过这个名称来操作容器。</p>
</li>
<li><p>-d：以demon进程的方式运行容器。</p>
</li>
<li><p>-v Users&#x2F;coder-home&#x2F;docker_mysql_ha&#x2F;mmm&#x2F;slave2:<br>&#x2F;etc&#x2F;mysql&#x2F;conf.d：把本地的<code>/Users/coder-home/docker_mysql_ha/mmm/slave2</code><br>目录挂载到容器中的<code>/etc/mysql/conf.d</code><br>目录下。</p>
</li>
<li><p>-e MYSQL_ROOT_PASSWORD&#x3D;root：向容器内传入参数，我们指定MySQL数据库root用户的密码也为root。</p>
</li>
<li><p>-e TZ&#x3D;”Asia&#x2F;Shanghai”：向容器内传入参数，这里我们指定的容器中使用的系统的时区为上海时间。</p>
</li>
<li><p>-p 33022:3306：我们指定容器中的3306端口，映射到我们本地为33022。这样我们在本地访问MySQL服务的时候，就可以通过33022端口来访问。</p>
</li>
<li><p>mysql:5.7.31：这个是我们要运行的容器的名称和版本。如果本地没有这个容器名称和版本，则会从docker<br>hub中自动拉取这个镜像名称和版本到本地，然后再启动这个镜像。</p>
</li>
</ul>
<p>容器启动后，我们可以查看启动后的结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker ps  </span><br><span class="line">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES  </span><br><span class="line">5207089da9a5 mysql:5.7.31        &quot;docker-entrypoint.s…&quot;   About a minute ago Up About a minute 33060/tcp, 0.0.0.0:</span><br><span class="line"><span class="meta prompt_">33022-&gt;</span><span class="language-bash">3306/tcp mysql-ha-mmm-slave2</span>  </span><br><span class="line">1c8ff5960272 mysql:5.7.31        &quot;docker-entrypoint.s…&quot;   About a minute ago Up About a minute 33060/tcp, 0.0.0.0:</span><br><span class="line"><span class="meta prompt_">33021-&gt;</span><span class="language-bash">3306/tcp mysql-ha-mmm-master2</span>  </span><br><span class="line">d8d646ba25f1 mysql:5.7.31        &quot;docker-entrypoint.s…&quot;   About a minute ago Up About a minute 33060/tcp, 0.0.0.0:</span><br><span class="line"><span class="meta prompt_">33012-&gt;</span><span class="language-bash">3306/tcp mysql-ha-mmm-slave1</span>  </span><br><span class="line">d3d75d9cd930 mysql:5.7.31        &quot;docker-entrypoint.s…&quot;   About a minute ago Up About a minute 33060/tcp, 0.0.0.0:</span><br><span class="line"><span class="meta prompt_">33011-&gt;</span><span class="language-bash">3306/tcp mysql-ha-mmm-master1</span>  </span><br><span class="line">➜  ~</span><br></pre></td></tr></table></figure>

<p>下面我们查看每一个MySQL数据库容器的host文件中的IP地址：</p>
<ul>
<li>master1的host文件如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜ ~ docker exec -it mysql-ha-mmm-master1 bin/bash  </span><br><span class="line">root@master1:/# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.11 master1.mysql master1  </span><br><span class="line">root@master1:/#</span><br></pre></td></tr></table></figure>

<ul>
<li>master2的host文件如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker exec -it mysql-ha-mmm-master2 bin/bash  </span><br><span class="line">root@master2:/# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.21 master2.mysql master2  </span><br><span class="line">root@master2:/#</span><br></pre></td></tr></table></figure>

<ul>
<li>slave1的host文件如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker exec -it mysql-ha-mmm-slave1 bin/bash  </span><br><span class="line">root@slave1:/# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.12 slave1.mysql slave1  </span><br><span class="line">root@slave1:/#</span><br></pre></td></tr></table></figure>

<ul>
<li>slave2的host文件如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker exec -it mysql-ha-mmm-slave2 bin/bash  </span><br><span class="line">root@slave2:/# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.22 slave2.mysql slave2  </span><br><span class="line">root@slave2:/#</span><br></pre></td></tr></table></figure>

<p>上面我们启动的四个MySQL数据库实例，我们还需要一个监控节点，下面启动一个监控节点，用于安装MMM的监控服务。</p>
<p>为了和其他环境一致，这里我们也使用上面MySQL的镜像。如下是启动一个新的MySQL容器，这个容器，我们不在挂载MySQL的my.cnf配置文件了，因为这个MySQL数据库我们不会使用，我们只是在这个容器中安装MMM的监控服务，我们此时把这个MySQL数据库容器当成一个Debian版本的虚拟机来使用。</p>
<h1 id="启动监控节点"><a href="#启动监控节点" class="headerlink" title="启动监控节点"></a>启动监控节点</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --net=mysql-ha-mmm-network --hostname monitor.mysql --ip 172.20.0.10 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-monitor -d -e MYSQL\_ROOT_PASSWORD=root -e TZ=&quot;Asia/Shanghai&quot; -p 33010:3306 mysql:5.7.31</span><br></pre></td></tr></table></figure>

<p>查看这个监控节点的host文件如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker exec -it mysql-ha-mmm-monitor bin/bash  </span><br><span class="line">root@monitor:~# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.10 monitor.mysql monitor  </span><br><span class="line">root@monitor:~#</span><br></pre></td></tr></table></figure>

<h4 id="创建主从同步的数据库用户"><a href="#创建主从同步的数据库用户" class="headerlink" title="创建主从同步的数据库用户"></a>创建主从同步的数据库用户</h4><p>在组从同步的时候，从需要使用一个指定的用户去连接到主上面同步主上面的binlog日志。所以，我们需要在我们的主上面创建好这样的一个用户。因为在master1宕机之后，MMM组件会将master2提升为新的主库，所以需要在master1和master2上面都创建一个这样的用户，也就是下的命令需要在两个master节点上都执行一下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create user &#x27;repl_user&#x27;@&#x27;172.20.0.%&#x27; identified by &#x27;repl_user&#x27;;  </span><br><span class="line">grant replication slave on *.* to &#x27;repl_user&#x27;@&#x27;172.20.0.%&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="历史数据的同步"><a href="#历史数据的同步" class="headerlink" title="历史数据的同步"></a>历史数据的同步</h4><p>如果我们并不是基于一个新的集群环境来搭建，而是基于一个已经运行了一段时间的MySQL数据库来做集群，此时我们需要把选定的master节点上面的数据，先使用<code>mysqldump</code><br>命令导出为<code>.sql</code><br>文件，然后再把这个<code>.sql</code><br>文件导入到所有的slave节点上去。然后在可以开始下面的任务。</p>
<p>在master上面执行的导出的命令示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -proot \  </span><br><span class="line">--master-data=2 \  </span><br><span class="line">--single-transaction \  </span><br><span class="line">--flush-logs \  </span><br><span class="line">--triggers \  </span><br><span class="line">--routines \  </span><br><span class="line">--events \  </span><br><span class="line">-B mydb1 &gt; mydb1.sql</span><br></pre></td></tr></table></figure>

<p>在所有的slave节点上执行的导入数据的命令示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -proot &lt; mydb1.sql</span><br></pre></td></tr></table></figure>

<p>但是，我们是基于一个崭新的环境来做的，不涉及到历史数据的问题。所以，这一步我们可以省略。</p>
<h4 id="开启组从同步"><a href="#开启组从同步" class="headerlink" title="开启组从同步"></a>开启组从同步</h4><p>在所有的slave上面执行如下命令，此时的binlog文件和日志点的位置，可以在master1上面使用<code>show master status</code><br>命令查看，或者查看导出数据的时候，生成的<code>.sql</code><br>文件。在master1节点上执行<code>mysqldump</code><br>导出命令的时候，我们指定的<code>--master-data=2</code><br>，这个参数会在导出的<code>.sql</code><br>文件中标记当前master1节点上binlog日志的文件名称和日志偏移量。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=&#x27;172.20.0.11&#x27;, master_user=&#x27;repl_user&#x27;, master_password=&#x27;repl_user&#x27;,</span><br><span class="line">MASTER\_LOG\_FILE=&#x27;mysql-bin.000003&#x27;, MASTER\_LOG\_POS=1034;</span><br></pre></td></tr></table></figure>

<p>开启组从同步：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<p>查看同步状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show slave status\\G</span>  </span><br><span class="line">*************************** 1. row ***************************  </span><br><span class="line">Slave\_IO\_State: Waiting for master to send event  </span><br><span class="line">Master_Host: 172.20.0.11  </span><br><span class="line">Master\_User: repl\_user  </span><br><span class="line">Master_Port: 3306  </span><br><span class="line">Connect_Retry: 60  </span><br><span class="line">Master\_Log\_File: mysql-bin.000003  </span><br><span class="line">Read\_Master\_Log_Pos: 1034  </span><br><span class="line">Relay\_Log\_File: mysql-relay.000002  </span><br><span class="line">Relay\_Log\_Pos: 320  </span><br><span class="line">Relay\_Master\_Log_File: mysql-bin.000003  </span><br><span class="line">Slave\_IO\_Running: Yes  </span><br><span class="line">Slave\_SQL\_Running: Yes  </span><br><span class="line">Replicate\_Do\_DB:  </span><br><span class="line">Replicate\_Ignore\_DB:  </span><br><span class="line">Replicate\_Do\_Table:  </span><br><span class="line">Replicate\_Ignore\_Table:  </span><br><span class="line">Replicate\_Wild\_Do_Table:  </span><br><span class="line">Replicate\_Wild\_Ignore_Table:  </span><br><span class="line">Last_Errno: 0  </span><br><span class="line">Last_Error:  </span><br><span class="line">Skip_Counter: 0  </span><br><span class="line">Exec\_Master\_Log_Pos: 1034  </span><br><span class="line">Relay\_Log\_Space: 523  </span><br><span class="line">Until_Condition: None  </span><br><span class="line">Until\_Log\_File:  </span><br><span class="line">Until\_Log\_Pos: 0  </span><br><span class="line">Master\_SSL\_Allowed: No  </span><br><span class="line">Master\_SSL\_CA_File:  </span><br><span class="line">Master\_SSL\_CA_Path:  </span><br><span class="line">Master\_SSL\_Cert:  </span><br><span class="line">Master\_SSL\_Cipher:  </span><br><span class="line">Master\_SSL\_Key:  </span><br><span class="line">Seconds\_Behind\_Master: 0  </span><br><span class="line">Master\_SSL\_Verify\_Server\_Cert: No  </span><br><span class="line">Last\_IO\_Errno: 0  </span><br><span class="line">Last\_IO\_Error:  </span><br><span class="line">Last\_SQL\_Errno: 0  </span><br><span class="line">Last\_SQL\_Error:  </span><br><span class="line">Replicate\_Ignore\_Server_Ids:  </span><br><span class="line">Master\_Server\_Id: 11  </span><br><span class="line">Master_UUID: 047bcc07-7424-11eb-96b4-0242ac14000b  </span><br><span class="line">Master\_Info\_File: mysql.slave\_master\_info  </span><br><span class="line">SQL_Delay: 0  </span><br><span class="line">SQL\_Remaining\_Delay: NULL  </span><br><span class="line">Slave\_SQL\_Running_State: Slave has read all relay log; waiting for more updates  </span><br><span class="line">Master\_Retry\_Count: 86400  </span><br><span class="line">Master_Bind:  </span><br><span class="line">Last\_IO\_Error_Timestamp:  </span><br><span class="line">Last\_SQL\_Error_Timestamp:  </span><br><span class="line">Master\_SSL\_Crl:  </span><br><span class="line">Master\_SSL\_Crlpath:  </span><br><span class="line">Retrieved\_Gtid\_Set:  </span><br><span class="line">Executed\_Gtid\_Set:  </span><br><span class="line">Auto_Position: 0  </span><br><span class="line">Replicate\_Rewrite\_DB:  </span><br><span class="line">Channel_Name:  </span><br><span class="line">Master\_TLS\_Version:  </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置主与主的同步"><a href="#配置主与主的同步" class="headerlink" title="配置主与主的同步"></a>配置主与主的同步</h4><p>上面我们配置好了<code>master1-&gt;slave1，master1-&gt;slave2</code><br>的同步。我们还需要在master1和master2直接配置互相同步对方。</p>
<p>现在master2上面配置master1作为它的主库。参考上面slave1和slave2上面的配置。执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=&#x27;172.20.0.11&#x27;, MASTER\_LOG\_FILE=&#x27;mysql-bin.000003&#x27;, MASTER\_LOG\_POS=1034;</span><br><span class="line"></span><br><span class="line">start slave user=&#x27;repl_user&#x27; password=&#x27;repl_user&#x27;;</span><br><span class="line"></span><br><span class="line">show slave status\\G</span><br></pre></td></tr></table></figure>

<p>然后再配置master2到master1的同步。此时我们需要查看一下master2上面的binlog日志名称和日志偏移量是多少。使用如下命令查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show master status\\G</span>  </span><br><span class="line">*************************** 1. row ***************************  </span><br><span class="line">File: mysql-bin.000003  </span><br><span class="line">Position: 623  </span><br><span class="line">Binlog\_Do\_DB:  </span><br><span class="line">Binlog\_Ignore\_DB:  </span><br><span class="line">Executed\_Gtid\_Set:  </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_">mysql&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后我们登录到master1上面，执行如下命令，配置master2作为master1的主库。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=&#x27;172.20.0.21&#x27;, MASTER\_LOG\_FILE=&#x27;mysql-bin.000003&#x27;, MASTER\_LOG\_POS=623;</span><br><span class="line"></span><br><span class="line">start slave user=&#x27;repl_user&#x27; password=&#x27;repl_user&#x27;;</span><br><span class="line"></span><br><span class="line">show slave status\\G</span><br></pre></td></tr></table></figure>

<p>验证双主双从同步的效果如下：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62218319710000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62218319710000.png"></a></p>
<h3 id="安装MMM"><a href="#安装MMM" class="headerlink" title="安装MMM"></a>安装MMM</h3><h4 id="修改apt-get源"><a href="#修改apt-get源" class="headerlink" title="修改apt-get源"></a>修改apt-get源</h4><p>在下载MMM之前，我们先修改一下<code>apt-get</code><br>源，然后更新一下<code>apt-get</code><br>源。如下所示，因为此时的容器中，没有<code>vim</code><br>命令，所以我们使用<code>echo &quot;xxx&quot; &gt;/etc/apt/sources.list</code><br>的方式去更新<code>apt-get</code><br>的源。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;  </span><br><span class="line">deb http://mirrors.aliyun.com/debian/ buster main non-free contrib  </span><br><span class="line">deb http://mirrors.aliyun.com/debian-security buster/updates main  </span><br><span class="line">deb http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib  </span><br><span class="line">deb http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/debian-security buster/updates main  </span><br><span class="line">deb-src http://mirrors.aliyun.com/debian/ buster main non-free contrib  </span><br><span class="line">deb-src http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib  </span><br><span class="line">deb-src http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib  </span><br><span class="line">&quot; &gt; etc/apt/sources.list</span><br></pre></td></tr></table></figure>

<p>注意，在更新镜像源的时候，要根据自己的Debian系统的版本，我的Debian系统的版本是<code>buster</code><br>版本，所以你要根据自己的系统版本网上找到对应的镜像地址。接着，我们更新一下系统。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/apt# apt-get update  </span><br><span class="line">Get:1 http://security.debian.org/debian-security buster/updates InRelease \[65.4 kB\]  </span><br><span class="line">Get:2 http://repo.mysql.com/apt/debian buster InRelease \[21.5 kB\]  </span><br><span class="line">Get:3 http://mirrors.ustc.edu.cn/debian buster InRelease \[122 kB\]  </span><br><span class="line">Get:4 http://security.debian.org/debian-security buster/updates/main amd64 Packages \[267 kB\]  </span><br><span class="line">Get:5 http://mirrors.ustc.edu.cn/debian buster-updates InRelease \[51.9 kB\]  </span><br><span class="line">Get:6 http://mirrors.ustc.edu.cn/debian buster/main amd64 Packages \[7907 kB\]  </span><br><span class="line">Get:7 http://repo.mysql.com/apt/debian buster/mysql-5.7 amd64 Packages \[5693 B\]  </span><br><span class="line">Get:8 http://mirrors.ustc.edu.cn/debian buster-updates/main amd64 Packages \[9504 B\]  </span><br><span class="line">Fetched 8450 kB in 10s (871 kB/s)  </span><br><span class="line">Reading package lists... Done  </span><br><span class="line">root@master1:/etc/apt#</span><br></pre></td></tr></table></figure>

<p>更新完成之后，我们先安装一下我们经常用到的几个命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install net-tools wget vim make cmake inetutils-ping iproute2 iproute2-doc -y</span><br></pre></td></tr></table></figure>

<h4 id="下载MMM"><a href="#下载MMM" class="headerlink" title="下载MMM"></a>下载MMM</h4><p>推荐使用源码来安装，这样可以在任何Linux系统版本上面进行安装，例如：Ubuntu、Debian、CentOS、Redhat等等。不用因为系统版本的问题找对应的<code>rpm</code><br>包，找对应的<code>deb</code><br>包。</p>
<p>通过如下步骤来获取MMM的源码。</p>
<p>登录Debian的官方网站：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.debin.org,然后点击跟多关于下载与软件介绍的连接./">https://www.debin.org，然后点击跟多关于下载与软件介绍的连接。</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62227796992000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62227796992000.png"></a></p>
<p>此时我们会进入如下页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.debian.org/intro/index#software%EF%BC%8C%E7%84%B6%E5%90%8E%E7%82%B9%E5%87%BB%E8%BD%AF%E4%BB%B6%E5%8C%85%E8%BF%9E%E6%8E%A5%E3%80%82">https://www.debian.org/intro/index#software，然后点击软件包连接。</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62232996113000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62232996113000.png"></a></p>
<p>接着，我们会进入如下页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.debian.org/distrib/packages#search_packages%EF%BC%8C%E6%A0%B9%E6%8D%AE%E9%80%89%E9%A1%B9%E8%BE%93%E5%85%A5%60mysql-mmm%60">https://www.debian.org/distrib/packages#search_packages，根据选项输入`mysql-mmm`</a><br>，点击搜索按钮。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62238380248100.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62238380248100.png"></a></p>
<p>点击上面的搜索按钮后，进入如下页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://packages.debian.org/search?keywords=mysql-mmm&searchon=names&suite=oldstable&section=all%EF%BC%8C%E7%84%B6%E5%90%8E%E6%88%91%E4%BB%AC%E7%82%B9%E5%87%BB%E9%A1%B5%E9%9D%A2%E4%B8%AD%E7%9A%84Debian%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%89%88%E6%9C%AC%EF%BC%8C%E9%80%89%E6%8B%A9%60jessie%60">https://packages.debian.org/search?keywords=mysql-mmm&amp;searchon=names&amp;suite=oldstable&amp;section=all，然后我们点击页面中的Debian系统的版本，选择`jessie`</a><br>版本，因为<code>mysql-mmm</code><br>是比较老的一种MySQL考可用架构，在最新的Debian系统中，已经没有这样的软件包了，所以我们选择老版本的<code>jessie</code><br>版本，这个版本中包含<code>mysql-mmm</code><br>的源码。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62244923390700.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62244923390700.png"></a></p>
<p>点击完成<code>jessie</code><br>之后，进入如下页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://packages.debian.org/search?suite=jessie&searchon=names&keywords=mysql-mmm%EF%BC%8C%E6%AD%A4%E6%97%B6%E6%88%91%E4%BB%AC%E5%B7%B2%E7%BB%8F%E6%90%9C%E7%B4%A2%E5%88%B0%E4%BA%86%60mysql-mmm%60">https://packages.debian.org/search?suite=jessie&amp;searchon=names&amp;keywords=mysql-mmm，此时我们已经搜索到了`mysql-mmm`</a><br>的软件。点击其中任何一个链接，进入详细页面。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62249976051000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62249976051000.png"></a></p>
<p>进入如下的页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://packages.debian.org/jessie/mysql-mmm-tools%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%89%E6%8B%A9%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E6%96%87%E4%BB%B6%E3%80%82">https://packages.debian.org/jessie/mysql-mmm-tools，我们选择下载源码文件。</a></p>
<p>或者我们可以右键复制下载地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://deb.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm_2.2.1.orig.tar.gz%EF%BC%8C%E4%BD%BF%E7%94%A8wget%E5%91%BD%E4%BB%A4%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E5%88%B0MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E3%80%82">http://deb.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm_2.2.1.orig.tar.gz，使用wget命令下载源码到MySQL服务器上。</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://deb.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm_2.2.1.orig.tar.gz</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62257452614500.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62257452614500.png"></a></p>
<p>如果要下载.deb文件，可以点击上面图片中的硬件架构下面的<code>all</code><br>连接，进入下面页面后，选择对应的距离我们最近镜像地址，我选择的为<code>ftp.cn.debian.org</code><br>这个镜像地址，然后复制下载链接地址，使用wget下载即可。这里贴出如下的下载示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.cn.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm-tools\_2.2.1-1.1\_all.deb  </span><br><span class="line">wget http://ftp.cn.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm-monitor\_2.2.1-1.1\_all.deb  </span><br><span class="line">wget http://ftp.cn.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm-common\_2.2.1-1.1\_all.deb  </span><br><span class="line">wget http://ftp.cn.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm-agent\_2.2.1-1.1\_all.deb</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62278934447800.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62278934447800.png"></a></p>
<h4 id="编译安装MMM"><a href="#编译安装MMM" class="headerlink" title="编译安装MMM"></a>编译安装MMM</h4><p>我们是使用的MySQL的容器镜像来启动的MySQL集群，而这个从docker<br>hub上面拉取的MySQL5.7官方版本的镜像是基于Debian系统来制作的，所以我们此次安装MMM软件需要基于Debian系统来安装。</p>
<p>下载好的<code>mysql-mmm</code><br>如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# ls -lstr  </span><br><span class="line">total 60  </span><br><span class="line">56 -rw-r--r-- 1 root root 55278 Feb 21 16:22 mysql-mmm_2.2.1.orig.tar.gz  </span><br><span class="line">4 drwxr-xr-x 2 root root 4096 Feb 21 16:24 deb  </span><br><span class="line">root@test:~#</span><br></pre></td></tr></table></figure>

<p>解压并且安装，但是在安装MMM之前，先安装一下它的依赖包，使用如下命令来安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install liblog-log4perl-perl libmailtools-perl liblog-dispatch-perl libclass-singleton-perl libproc-daemon-perl</span><br><span class="line">libalgorithm-diff-perl libdbi-perl libdbd-mysql-perl -y</span><br></pre></td></tr></table></figure>

<p>安装MMM的命令和过程如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# tar -zxf mysql-mmm_2.2.1.orig.tar.gz  </span><br><span class="line">root@test:~# ls -lstr  </span><br><span class="line">total 64  </span><br><span class="line">4 drwxr-xr-x 6 root root 4096 May 7 2010 mysql-mmm-2.2.1  </span><br><span class="line">56 -rw-r--r-- 1 root root 55278 Feb 21 16:22 mysql-mmm_2.2.1.orig.tar.gz  </span><br><span class="line">4 drwxr-xr-x 2 root root 4096 Feb 21 16:24 deb  </span><br><span class="line">root@test:~# cd mysql-mmm-2.2.1/  </span><br><span class="line">root@test:~/mysql-mmm-2.2.1# make install  </span><br><span class="line">mkdir -p usr/share/perl5/MMM usr/lib/mysql-mmm usr/sbin var/log/mysql-mmm etc etc/mysql-mmm etc/init.d/  </span><br><span class="line">cp -r lib/Common/ usr/share/perl5/MMM  </span><br><span class="line">\[ -f etc/mysql-mmm/mmm_common.conf \] || cp etc/mysql-mmm/mmm_common.conf etc/mysql-mmm/  </span><br><span class="line">mkdir -p usr/lib/mysql-mmm/agent/  </span><br><span class="line">cp -r lib/Agent/ usr/share/perl5/MMM  </span><br><span class="line">cp -r bin/agent/* usr/lib/mysql-mmm/agent/  </span><br><span class="line">cp -r etc/init.d/mysql-mmm-agent etc/init.d/  </span><br><span class="line">cp sbin/mmm_agentd usr/sbin  </span><br><span class="line">\[ -f etc/mysql-mmm/mmm_agent.conf \] || cp etc/mysql-mmm/mmm_agent.conf etc/mysql-mmm/  </span><br><span class="line">mkdir -p usr/lib/mysql-mmm/monitor/  </span><br><span class="line">cp -r lib/Monitor/ usr/share/perl5/MMM  </span><br><span class="line">cp -r bin/monitor/* usr/lib/mysql-mmm/monitor/  </span><br><span class="line">cp -r etc/init.d/mysql-mmm-monitor etc/init.d/  </span><br><span class="line">cp sbin/mmm\_control sbin/mmm\_mond usr/sbin  </span><br><span class="line">\[ -f etc/mysql-mmm/mmm_mon.conf \] || cp etc/mysql-mmm/mmm_mon.conf etc/mysql-mmm/  </span><br><span class="line">mkdir -p usr/lib/mysql-mmm/tools/  </span><br><span class="line">cp -r lib/Tools/ usr/share/perl5/MMM  </span><br><span class="line">cp -r bin/tools/* usr/lib/mysql-mmm/tools/  </span><br><span class="line">cp sbin/mmm\_backup sbin/mmm\_clone sbin/mmm_restore usr/sbin  </span><br><span class="line">\[ -f etc/mysql-mmm/mmm_tools.conf \] || cp etc/mysql-mmm/mmm_tools.conf etc/mysql-mmm/  </span><br><span class="line">root@test:~/mysql-mmm-2.2.1#</span><br></pre></td></tr></table></figure>

<p>如果在安装<code>mmm</code><br>的时候，提示没有<code>make</code><br>命令，则需要先安装<code>make</code><br>命令，安装的时候如果是Debian或Ubuntu系统，使用如下apt-get命令安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install make cmake -y</span><br></pre></td></tr></table></figure>

<p>如果是CentOS或Redhat系统，则使用如下的yum命令来安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install make cmake -y</span><br></pre></td></tr></table></figure>

<p>以上编译安装MMM需要在每一个节点都执行，包括两个master节点和两个slave节点，还有monitor监控节点也要安装。</p>
<p>安装完MMM之后，我们需要注意一下几个目录，这是我们使用MMM服务的基础。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MMM各种配置文件所在目录</span>  </span><br><span class="line">/etc/mysql-mmm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MMM服务日志文件所在目录</span>  </span><br><span class="line">/var/log/mysql-mmm/mmm_mond.log # MMM的monitor服务的日志文件  </span><br><span class="line">/var/log/mysql-mmm/mmm_agentd.log # MMM的agent服务的日志文件</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">各种perl脚本所在目录</span>  </span><br><span class="line">/usr/lib/mysql-mmm/agent # agent客户端各种脚本所在目录  </span><br><span class="line">/usr/lib/mysql-mmm/monitor # monitor监控端各种脚本所在目录  </span><br><span class="line">/usr/lib/mysql-mmm/tools # 工具包脚本所在目录</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动和关闭MMM服务的脚本文件</span>  </span><br><span class="line">/etc/init.d/mysql-mmm-agent  </span><br><span class="line">/etc/init.d/mysql-mmm-monitor</span><br></pre></td></tr></table></figure>

<h3 id="创建MMM使用的MySQL用户"><a href="#创建MMM使用的MySQL用户" class="headerlink" title="创建MMM使用的MySQL用户"></a>创建MMM使用的MySQL用户</h3><p>监控用和客户端用户，在所有的节点上都要创建这两个用户。如果已经配置组从同步，在master1上创建就OK，其他节点会自动同步这两个创建好的用户到其他节点。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create user &#x27;mmm_monitor&#x27;@&#x27;172.20.0.%&#x27; identified by &#x27;mmm_monitor&#x27;;  </span><br><span class="line">grant replication client on *.* to &#x27;mmm_monitor&#x27;@&#x27;172.20.0.%&#x27;;</span><br><span class="line"></span><br><span class="line">create user &#x27;mmm_agent&#x27;@&#x27;172.20.0.%&#x27; identified by &#x27;mmm_agent&#x27;;  </span><br><span class="line">grant super, replication client, process on *.* to &#x27;mmm_agent&#x27;@&#x27;172.20.0.%&#x27;;</span><br></pre></td></tr></table></figure>

<p>需要注意的是这两个用户的权限不同，结合前面我们配置组从同步的哪一个用户，我们来对比一下：</p>
<ul>
<li><p>monitor：MMM监控使用的用户，拥有replication client权限就可以。</p>
</li>
<li><p>agent：MMM客户单使用的用，拥有super、replication client、process权限。</p>
</li>
<li><p>replication：组从同步使用的用户，拥有replication slave权限即可。</p>
</li>
</ul>
<p>最后的用户在四个节点上面的结果如下图所示：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62291961300000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62291961300000.png"></a></p>
<h3 id="修改MMM的配置文件"><a href="#修改MMM的配置文件" class="headerlink" title="修改MMM的配置文件"></a>修改MMM的配置文件</h3><p>MMM所有的配置文件都在如下目录中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/mysql-mmm# ls -lstr etc/mysql-mmm/*  </span><br><span class="line">4 -rw-r----- 1 root root 321 Feb 22 21:46 etc/mysql-mmm/mmm_mon.conf  </span><br><span class="line">4 -rw-r----- 1 root root 1293 Feb 22 21:46 etc/mysql-mmm/mmm_tools.conf  </span><br><span class="line">4 -rw-r----- 1 root root 37 Feb 22 22:21 etc/mysql-mmm/mmm_agent.conf  </span><br><span class="line">4 -rw-r----- 1 root root 789 Feb 22 23:20 etc/mysql-mmm/mmm_common.conf  </span><br><span class="line">root@master1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p><strong>mmm_comm.conf配置文件</strong></p>
<p>所有5个节点中的<code>/etc/mysql-mmm/mmm_common.conf</code><br>配置文件都修改为如下所示的内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/mysql-mmm# cat mmm_common.conf</span><br><span class="line"></span><br><span class="line">active\_master\_role writer</span><br><span class="line">&lt;host default&gt;  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网卡的名称，各个主机上面网络设备的名称</span>  </span><br><span class="line">	cluster_interface		eth0</span><br><span class="line"></span><br><span class="line">	pid\_path			/var/run/mmm\_agentd.pid  </span><br><span class="line">	bin_path			/usr/lib/mysql-mmm/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主从复制用户名和密码</span>  </span><br><span class="line">replication\_user repl\_user  </span><br><span class="line">replication\_password repl\_user</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MMM服务使用的anget用户名和密码</span>  </span><br><span class="line">agent\_user mmm\_agent  </span><br><span class="line">agent\_password mmm\_agent</span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master1的配置信息</span>  </span><br><span class="line">&lt;host master1&gt;  </span><br><span class="line">ip 172.20.0.11  </span><br><span class="line">mode master  </span><br><span class="line">peer master2  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master2的配置信息</span>  </span><br><span class="line">&lt;host master2&gt;  </span><br><span class="line">ip 172.20.0.21  </span><br><span class="line">mode master  </span><br><span class="line">peer master1  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slave1的配置信息</span>  </span><br><span class="line">&lt;host slave1&gt;  </span><br><span class="line">ip 172.20.0.12  </span><br><span class="line">mode slave  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slave2的配置信息</span>  </span><br><span class="line">&lt;host slave2&gt;  </span><br><span class="line">ip 172.20.0.22  </span><br><span class="line">mode slave  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写虚拟IP的配置信息，指定可写的主机名称</span>  </span><br><span class="line">&lt;role writer&gt;  </span><br><span class="line">hosts master1, master2  </span><br><span class="line">ips 172.20.0.100  </span><br><span class="line">mode exclusive  </span><br><span class="line">&lt;/role&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">读虚拟IP的配置信息，指定可以提供读服务的主机名称。下面的VIP和主键名称不一定是一一对应的，VIP是随机分布到各个可读节点的。</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果提供多个VIP，有可能一个节点被分配多个VIP，这样也是支持的。</span>  </span><br><span class="line">&lt;role reader&gt;  </span><br><span class="line">hosts master1, master2, slave1, slave2  </span><br><span class="line">ips 172.20.0.111, 172.20.0.211, 172.20.0.122, 172.20.0.222  </span><br><span class="line">mode balanced  </span><br><span class="line">&lt;/role&gt;</span><br><span class="line">root@master1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>上面的<code>role reader</code><br>中配置的可读节点，可以根据自己的需求来配置，这里我把<code>master1, master2, slave1, slave2</code><br>都作为可读的节点，当然可以把主节点<code>master1</code><br>去掉，只配置<code>master2, slave1, slave2</code><br>三个节点。这里的<code>ips</code><br>也是我们指定的VIP的值，我们可以配置多个VIP，最好是VIP的个数和上面的host的数目一致，表示每一个提供读的节点分配一个VIP。</p>
<p><strong>mmm_agent.conf配置文件</strong></p>
<p>每一个节点上面的<code>/etc/mysql-mmm/mmm_agent.conf</code><br>配置文件中，都在第2行中，修改一下主机名称。下面给出master1节点的配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/mysql-mmm# cat mmm_agent.conf  </span><br><span class="line">include mmm_common.conf  </span><br><span class="line">this master1  </span><br><span class="line">root@master1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>其他master2、slave1、slave2各个节点也需要作出对应的修改。只要把master1改为对应的主机名称即可。</p>
<p><strong>mmm_mon.conf配置文件</strong></p>
<p>在monitor节点上，修改<code>/etc/mysql-mmm/mmm_mon.conf</code><br>配置文件，修改内容如下所示，其他四个节点不需要对这个文件做修改。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# cat mmm_mon.conf  </span><br><span class="line">include mmm_common.conf</span><br><span class="line"></span><br><span class="line">&lt;monitor&gt;  </span><br><span class="line">	ip					127.0.0.1  </span><br><span class="line">	pid\_path				/var/run/mmm\_mond.pid  </span><br><span class="line">	bin_path				/usr/lib/mysql-mmm/  </span><br><span class="line">	status\_path				/var/lib/misc/mmm\_mond.status  </span><br><span class="line">	ping_ips				172.20.0.1, 172.20.0.11, 172.20.0.21, 172.20.0.12, 172.20.0.22 # 网关IP地址，和各个节点的物理IP地址，用于监控各个节点的状态是否可用  </span><br><span class="line">&lt;/monitor&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MMM服务使用MySQL中的monitor用户名称和密码</span>  </span><br><span class="line">&lt;host default&gt;  </span><br><span class="line">monitor\_user mmm\_monitor  </span><br><span class="line">monitor\_password mmm\_monitor  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">debug值为0非debug模式，为1的时候表示debug模式，debug模式下，会在/var/log/mysql-mmm/mmm_mond.log日志文件中生成更多日志信息。</span>  </span><br><span class="line">debug 0  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<h3 id="启动MMM服务"><a href="#启动MMM服务" class="headerlink" title="启动MMM服务"></a>启动MMM服务</h3><p>客户端agent服务相关命令如下，客户端agent启动后日志存放在<code>/var/log/mysql-mmm/mmm_agentd.log</code><br>文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql-mmm-agent start  </span><br><span class="line">/etc/init.d/mysql-mmm-agent status  </span><br><span class="line">/etc/init.d/mysql-mmm-agent stop  </span><br><span class="line">/etc/init.d/mysql-mmm-agent restart</span><br></pre></td></tr></table></figure>

<p>监控端monitor服务相关命令如下，监控端monitor启动后日志存放在<code>/var/log/mysql-mmm/mmm_mond.log</code><br>文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql-mmm-monitor start  </span><br><span class="line">/etc/init.d/mysql-mmm-monitor status  </span><br><span class="line">/etc/init.d/mysql-mmm-monitor stop  </span><br><span class="line">/etc/init.d/mysql-mmm-monitor restart</span><br></pre></td></tr></table></figure>

<p>MMM监控状态有一个管理命令<code>mmm_control</code><br>，它的使用帮助如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/# mmm_control --help  </span><br><span class="line">Invalid command &#x27;--help&#x27;</span><br><span class="line"></span><br><span class="line">Valid commands are:  </span><br><span class="line">help \- show this message  </span><br><span class="line">ping \- ping monitor  </span><br><span class="line">show - show status  </span><br><span class="line">checks \[&lt;host&gt;|all \[&lt;check&gt;|all\]\] - show checks status  </span><br><span class="line">set_online &lt;host&gt;                 \- set host &lt;host&gt; online  </span><br><span class="line">set_offline &lt;host&gt;                \- set host &lt;host&gt; offline  </span><br><span class="line">mode - print current mode.  </span><br><span class="line">set_active - switch into active mode.  </span><br><span class="line">set_manual - switch into manual mode.  </span><br><span class="line">set_passive - switch into passive mode.  </span><br><span class="line">move_role \[--force\] &lt;role&gt; &lt;host&gt; \- move exclusive role &lt;role&gt; to host &lt;host&gt;  </span><br><span class="line">(Only use --force if you know what you are doing!)  </span><br><span class="line">set_ip &lt;ip&gt; &lt;host&gt;                \- set role with ip &lt;ip&gt; to host &lt;host&gt;</span><br><span class="line"></span><br><span class="line">root@monitor:/#</span><br></pre></td></tr></table></figure>

<p>常用的维护节点状态的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mmm_control show  </span><br><span class="line">mmm_control checks all  </span><br><span class="line">mmm\_control set\_online master1  </span><br><span class="line">mmm\_control set\_online master2  </span><br><span class="line">mmm\_control set\_online slave1  </span><br><span class="line">mmm\_control set\_online slave2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>下面分别在四个MySQL节点上执行如下命令启动并查看MMM的客户端服务</strong></p>
<ul>
<li>master1主节点上，启动和查看MMM的客户端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Starting MMM Agent daemon... Ok</span><br><span class="line"></span><br><span class="line">root@master1:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Checking MMM Agent process: running.  </span><br><span class="line">root@master1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<ul>
<li>master2主节点上，启动和查看MMM的客户端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@master2:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Starting MMM Agent daemon... Ok</span><br><span class="line"></span><br><span class="line">root@master2:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Checking MMM Agent process: running.  </span><br><span class="line">root@master2:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<ul>
<li>slave1主节点上，启动和查看MMM的客户端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@slave1:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Starting MMM Agent daemon... Ok</span><br><span class="line"></span><br><span class="line">root@slave1:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Checking MMM Agent process: running.  </span><br><span class="line">root@slave1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<ul>
<li>slave2主节点上，启动MMM的客户端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@slave2:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Starting MMM Agent daemon... Ok</span><br><span class="line"></span><br><span class="line">root@slave2:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Checking MMM Agent process: running.  </span><br><span class="line">root@slave2:/etc/mysql-mmm#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>下面在监控节点上执行如下命令启动并查看MMM的监控服务</strong></p>
<ul>
<li>monitor节点上，启动和查看MMM的监控端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# etc/init.d/mysql-mmm-monitor start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_mond&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_mond.pid&#x27;  </span><br><span class="line">Starting MMM Monitor daemon: Ok</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm# etc/init.d/mysql-mmm-monitor status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_mond&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_mond.pid&#x27;  </span><br><span class="line">Checking MMM Monitor process: running.  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<ul>
<li>在monitor节点，查看监控的状态：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/AWAITING_RECOVERY. Roles:  </span><br><span class="line">master2(172.20.0.21) master/AWAITING_RECOVERY. Roles:  </span><br><span class="line">slave1(172.20.0.12) slave/AWAITING_RECOVERY. Roles:  </span><br><span class="line">slave2(172.20.0.22) slave/AWAITING_RECOVERY. Roles:</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online master1;  </span><br><span class="line">OK: State of &#x27;master1&#x27; changed to ONLINE. Now you can wait some time and check its new roles!  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online master2  </span><br><span class="line">OK: State of &#x27;master2&#x27; changed to ONLINE. Now you can wait some time and check its new roles!  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online slave1  </span><br><span class="line">OK: State of &#x27;slave1&#x27; changed to ONLINE. Now you can wait some time and check its new roles!  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online slave2  </span><br><span class="line">OK: State of &#x27;slave2&#x27; changed to ONLINE. Now you can wait some time and check its new roles!  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/ONLINE. Roles: reader(172.20.0.111), writer(172.20.0.100)  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.211)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.122)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p><strong>问题排查1：monitor服务不能正常启动？</strong></p>
<p>当在monitor节点启动监控服务后，监控服务一会就异常退出了。原因是在使用docker启动集群节点的时候没有使用<code>--cap-add NET_ADMIN</code><br>参数，没有这个参数就没有办法在容器只用使用虚拟VIP的功能。在删除容器后，增加参数重新运行后，才运行起来。</p>
<p>后来，又发现monitor节点启监控服务器仍然失败，查看日志<code>/var/log/mysql-mmm/mmm_mond.log</code><br>，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# tail -f var/log/mysql-mmm/mmm_mond.log  </span><br><span class="line">2021/02/22 23:26:27 INFO Waiting for network connection...  </span><br><span class="line">2021/02/22 23:26:27 INFO Spawning checker &#x27;ping_ip&#x27;...  </span><br><span class="line">2021/02/22 23:26:27 INFO Shutting down checker &#x27;ping_ip&#x27;...  </span><br><span class="line">2021/02/22 23:26:27 INFO Network connection is available.  </span><br><span class="line">2021/02/22 23:26:27 FATAL Child exited with exitcode 255, restarting after 10 second sleep</span><br></pre></td></tr></table></figure>

<p>修改<code>/etc/mysql-mmm/mmm_mon.conf</code><br>配置文件中的<code>debug</code><br>的值为<code>1</code><br>，表示以<code>debug</code><br>的模式运行monitor服务，此时我们再重新启动monitor服务，查看输出的详细错误日志如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# etc/init.d/mysql-mmm-monitor start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_mond&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_mond.pid&#x27;  </span><br><span class="line">Starting MMM Monitor daemon: 2021/02/22 23:30:17 INFO STARTING...  </span><br><span class="line">2021/02/22 23:30:17 DEBUG Created pid file &#x27;/var/run/mmm_mond.pid&#x27; with pid 5330  </span><br><span class="line">2021/02/22 23:30:17 INFO Waiting for network connection...  </span><br><span class="line">2021/02/22 23:30:17 INFO Spawning checker &#x27;ping_ip&#x27;...  </span><br><span class="line">2021/02/22 23:30:17 DEBUG IP &#x27;172.20.0.1&#x27; is reachable: OK  </span><br><span class="line">2021/02/22 23:30:17 INFO Shutting down checker &#x27;ping_ip&#x27;...  </span><br><span class="line">2021/02/22 23:30:17 INFO Network connection is available.  </span><br><span class="line">Use of uninitialized value $old_state in string ne at usr/share/perl5/MMM/Monitor/Agent.pm line 42.  </span><br><span class="line">2021/02/22 23:30:17 FATAL Child exited with exitcode 255, restarting after 10 second sleep</span><br></pre></td></tr></table></figure>

<p>于是去修改了<code>/usr/share/perl5/MMM/Monitor/Agent.pm</code><br>文件，在第41行增加如下内容，保存退出，重新启动monitor服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (! defined($old\_state)) &#123; $old\_state = &#x27;certinally not new_state&#x27;; &#125;</span><br></pre></td></tr></table></figure>

<p>然后再次重启monitor服务，启动成功。然后把<code>/etc/mysql-mmm/mmm_mon.conf</code><br>配置文件中的<code>debug</code><br>的值再次修改为<code>0</code><br>，关闭<code>debug</code><br>模式再次重启monitor服务。此时查看monitor服务的日志内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/# tail -f var/log/mysql-mmm/mmm_mond.log  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_backlog&#x27; on &#x27;slave1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_backlog&#x27; on &#x27;master2&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_threads&#x27; on &#x27;master1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_threads&#x27; on &#x27;slave2&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_threads&#x27; on &#x27;slave1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_threads&#x27; on &#x27;master2&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;ping&#x27; on &#x27;master1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;ping&#x27; on &#x27;slave2&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;ping&#x27; on &#x27;slave1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;ping&#x27; on &#x27;master2&#x27; is ok!</span><br></pre></td></tr></table></figure>

<p><strong>问题排查2：虚拟IP不能再各个节点生成？</strong></p>
<p>启动MMM后，发现不能通过VIP访问MySQL数据库，去各个节点使用<code>ifconfig -a</code><br>或者<code>ip addr</code><br>命令查看发现没有对应的VIP生成。查看了各个节点MMM agent服务的日志文件<code>/var/log/mysql-mmm/mmm_agent.log</code><br>，发现如下错误信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/# tail -f var/log/mysql-mmm/mmm_agentd.log  </span><br><span class="line">2021/02/23 17:16:19 FATAL Couldn&#x27;t configure IP &#x27;172.20.0.111&#x27; on interface &#x27;eth0&#x27;: undef  </span><br><span class="line">2021/02/23 17:16:19 FATAL Couldn&#x27;t allow writes: undef  </span><br><span class="line">2021/02/23 17:16:22 FATAL Couldn&#x27;t configure IP &#x27;172.20.0.111&#x27; on interface &#x27;eth0&#x27;: undef  </span><br><span class="line">2021/02/23 17:16:22 FATAL Couldn&#x27;t allow writes: undef</span><br></pre></td></tr></table></figure>

<p>经过排查发现是在设置VIP的时候失败，设置客户端VIP的脚本如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/mysql-mmm/agent/configure_ip</span><br></pre></td></tr></table></figure>

<p>执行上面的脚本发现如下错误：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62316071988900.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62316071988900.png"></a></p>
<p>提示我们，需要在perl中安装arp.pm包。安装的时候，为了提高速度，我们修改一下perl安装模块的时候使用的镜像源。</p>
<p>修改perl安装包的时候使用的镜像源，参考如下方式修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/# perl -MCPAN -e shell  </span><br><span class="line">cpan\[5\]&gt; o conf urllist  </span><br><span class="line">urllist  </span><br><span class="line">0 \[http://www.cpan.org/\] </span><br><span class="line">Type &#x27;o conf&#x27; to view all configuration items</span><br><span class="line"></span><br><span class="line">cpan\[6\]&gt; o conf urllist push http://mirrors.aliyun.com/CPAN/  </span><br><span class="line">Please use &#x27;o conf commit&#x27; to make the config permanent!</span><br><span class="line"></span><br><span class="line">cpan\[7\]&gt; o conf commit  </span><br><span class="line">commit: wrote &#x27;/root/.cpan/CPAN/MyConfig.pm&#x27;</span><br><span class="line"></span><br><span class="line">cpan\[8\]&gt; o conf urllist  </span><br><span class="line">urllist  </span><br><span class="line">0 \[http://www.cpan.org/\] </span><br><span class="line">1 \[http://mirrors.aliyun.com/CPAN/\] </span><br><span class="line">Type &#x27;o conf&#x27; to view all configuration items</span><br><span class="line"></span><br><span class="line">cpan\[9\]&gt; install Net::ARP</span><br><span class="line"></span><br><span class="line">cpan\[10\]&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中各个命令的含义如下：</p>
<ul>
<li><p><code>o conf urllist</code><br>：查看的当前的镜像源</p>
</li>
<li><p><code>o conf urllist push http://mirrors.aliyun.com/CPAN/</code><br>：添加阿里的perl镜像源</p>
</li>
<li><p><code>o conf commit</code><br>：提交对镜像源的修改</p>
</li>
<li><p><code>install Net::ARP</code><br>：安装arp.pm包。</p>
</li>
</ul>
<p>经过上面的安装方式，发现安装失败。于是下载源码自己编译安装这个包。参考如下命令顺序来编译安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载源码文件</span>  </span><br><span class="line">wget https://cpan.metacpan.org/authors/id/C/CR/CRAZYDJ/Net-ARP-1.0.11.tgz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压下载后的文件</span>  </span><br><span class="line">tar -zxvf Net-ARP-1.0.11.tgz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入下载目录</span>  </span><br><span class="line">cd Net-ARP-1.0.11</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行编译</span>  </span><br><span class="line">perl Makefile.PL</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行安装</span>  </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>上面安装Net-ARP包的操作，需要在除了monitor节点的四个节点上都执行安装一下。</p>
<p>最后所有节点的IP地址和VIP地址如下所示：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62324916880500.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62324916880500.png"></a></p>
<h3 id="验证VIP访问数据库"><a href="#验证VIP访问数据库" class="headerlink" title="验证VIP访问数据库"></a>验证VIP访问数据库</h3><p>当我们的MMM客户段服务在四个MySQL数据库实例中启动，并且MMM监控服务在monitor节点启动之后。我们在monitor节点上面尝试使用各个VIP看能否正常连接到MySQL数据库。验证的结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm#  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/ONLINE. Roles: reader(172.20.0.111), writer(172.20.0.100)  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.122)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.211)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.100 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+---------------+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+---------------+  </span><br><span class="line">| master1.mysql |  </span><br><span class="line">+---------------+  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.111 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+---------------+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+---------------+  </span><br><span class="line">| master1.mysql |  </span><br><span class="line">+---------------+  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.122 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+---------------+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+---------------+  </span><br><span class="line">| master2.mysql |  </span><br><span class="line">+---------------+  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.211 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+--------------+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+--------------+  </span><br><span class="line">| slave1.mysql |  </span><br><span class="line">+--------------+  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.222 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+--------------+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+--------------+  </span><br><span class="line">| slave2.mysql |  </span><br><span class="line">+--------------+  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<h3 id="验证MMM的高可用"><a href="#验证MMM的高可用" class="headerlink" title="验证MMM的高可用"></a>验证MMM的高可用</h3><p>我们把master1节点上面的MySQL服务停止掉，来验证一下是否会把主从同步的源头从master1切换为master2上面，并且我们在monitor节点上，仍然可以通过writer<br>vip 去连接到MySQL上。</p>
<p>停止master1节点上面的MySQL服务，在master1节点上，执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@master1:~/Net-ARP-1.0.11# etc/init.d/mysql stop  </span><br><span class="line">............  </span><br><span class="line">\[info\] MySQL Community Server 5.7.31 is stopped.  </span><br><span class="line">root@master1:~/Net-ARP-1.0.11# %   </span><br><span class="line">➜  ~</span><br></pre></td></tr></table></figure>

<p>接着，我们在monitor节点上，查看MMM监控各个节点服务的状态，发现master1节点以及下线了，并且我们的writer<br>ip，已经从原先的master1节点迁移到master2节点上了。如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warning: agent on host master1 is not reachable</span>  </span><br><span class="line">master1(172.20.0.11) master/HARD_OFFLINE. Roles:  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.122), writer(172.20.0.100)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.111), reader(172.20.0.211)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control checks all  </span><br><span class="line">slave2 ping \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave2 mysql \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave2 rep_threads \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave2 rep_backlog \[last change: 2021/02/23 16:19:44\] OK: Backlog is null  </span><br><span class="line">master1 ping \[last change: 2021/02/23 18:44:57\] ERROR: Could not ping 172.20.0.11  </span><br><span class="line">master1 mysql \[last change: 2021/02/23 18:44:40\] ERROR: Connect error (host = 172.20.0.11:3306, user = mmm_monitor)!</span><br><span class="line">Can&#x27;t connect to MySQL server on &#x27;172.20.0.11&#x27; (115)  </span><br><span class="line">master1 rep_threads \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">master1 rep_backlog \[last change: 2021/02/23 16:19:44\] OK: Backlog is null  </span><br><span class="line">slave1 ping \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave1 mysql \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave1 rep_threads \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave1 rep_backlog \[last change: 2021/02/23 16:19:44\] OK: Backlog is null  </span><br><span class="line">master2 ping \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">master2 mysql \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">master2 rep_threads \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">master2 rep_backlog \[last change: 2021/02/23 16:19:44\] OK: Backlog is null</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>此时我们看到master2上面的IP地址信息如下，<code>writer vip 172.20.0.100</code><br>已经迁移到了master2主机上了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@master2:~/Net-ARP-1.0.11# ip addr  </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000  </span><br><span class="line">link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00  </span><br><span class="line">inet 127.0.0.1/8 scope host lo  </span><br><span class="line">valid\_lft forever preferred\_lft forever  </span><br><span class="line">2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000  </span><br><span class="line">link/ipip 0.0.0.0 brd 0.0.0.0  </span><br><span class="line">3: ip6tnl0@NONE: &lt;NOARP&gt; mtu 1452 qdisc noop state DOWN group default qlen 1000  </span><br><span class="line">link/tunnel6 :: brd ::  </span><br><span class="line">12: eth0@if13: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default  </span><br><span class="line">link/ether 02:42:ac:14:00:15 brd ff:ff:ff:ff:ff:ff link-netnsid 0  </span><br><span class="line">inet 172.20.0.21/24 brd 172.20.0.255 scope global eth0  </span><br><span class="line">valid\_lft forever preferred\_lft forever  </span><br><span class="line">inet 172.20.0.122/32 scope global eth0  </span><br><span class="line">valid\_lft forever preferred\_lft forever  </span><br><span class="line">inet 172.20.0.100/32 scope global eth0  </span><br><span class="line">valid\_lft forever preferred\_lft forever  </span><br><span class="line">root@master2:~/Net-ARP-1.0.11#</span><br></pre></td></tr></table></figure>

<p>在monitor节点上，查看MMM的监控服务器的日志信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# tail -20 /var/log/mysql-mmm/mmm_mond.log  </span><br><span class="line">2021/02/23 16:19:49 INFO Check &#x27;mysql&#x27; on &#x27;slave2&#x27; is ok!  </span><br><span class="line">2021/02/23 16:19:49 INFO Check &#x27;mysql&#x27; on &#x27;master1&#x27; is ok!  </span><br><span class="line">2021/02/23 16:19:49 INFO Check &#x27;mysql&#x27; on &#x27;slave1&#x27; is ok!  </span><br><span class="line">2021/02/23 16:19:49 INFO Check &#x27;mysql&#x27; on &#x27;master2&#x27; is ok!  </span><br><span class="line">2021/02/23 18:44:30 WARN Check &#x27;rep_threads&#x27; on &#x27;master1&#x27; is in unknown state! Message: UNKNOWN: Connect error (host =</span><br><span class="line">172.20.0.11:3306, user = mmm_monitor)! Can&#x27;t connect to MySQL server on &#x27;172.20.0.11&#x27; (115)  </span><br><span class="line">2021/02/23 18:44:30 WARN Check &#x27;rep_backlog&#x27; on &#x27;master1&#x27; is in unknown state! Message: UNKNOWN: Connect error (host =</span><br><span class="line">172.20.0.11:3306, user = mmm_monitor)! Can&#x27;t connect to MySQL server on &#x27;172.20.0.11&#x27; (115)  </span><br><span class="line">2021/02/23 18:44:40 ERROR Check &#x27;mysql&#x27; on &#x27;master1&#x27; has failed for 10 seconds! Message: ERROR: Connect error (host =</span><br><span class="line">172.20.0.11:3306, user = mmm_monitor)! Can&#x27;t connect to MySQL server on &#x27;172.20.0.11&#x27; (115)  </span><br><span class="line">2021/02/23 18:44:41 FATAL State of host &#x27;master1&#x27; changed from ONLINE to HARD_OFFLINE (ping: OK, mysql: not OK)  </span><br><span class="line">2021/02/23 18:44:41 INFO Removing all roles from host &#x27;master1&#x27;:  </span><br><span class="line">2021/02/23 18:44:41 INFO Removed role &#x27;reader(172.20.0.111)&#x27; from host &#x27;master1&#x27;  </span><br><span class="line">2021/02/23 18:44:41 INFO Removed role &#x27;writer(172.20.0.100)&#x27; from host &#x27;master1&#x27;  </span><br><span class="line">2021/02/23 18:44:41 FATAL Can&#x27;t reach agent on host &#x27;master1&#x27;  </span><br><span class="line">2021/02/23 18:44:41 ERROR Can&#x27;t send offline status notification to &#x27;master1&#x27; \- killing it!  </span><br><span class="line">2021/02/23 18:44:41 FATAL Could not kill host &#x27;master1&#x27; \- there may be some duplicate ips now! (There&#x27;s no binary</span><br><span class="line">configured for killing hosts.)  </span><br><span class="line">2021/02/23 18:44:41 INFO Orphaned role &#x27;writer(172.20.0.100)&#x27; has been assigned to &#x27;master2&#x27;  </span><br><span class="line">2021/02/23 18:44:41 INFO Orphaned role &#x27;reader(172.20.0.111)&#x27; has been assigned to &#x27;slave1&#x27;  </span><br><span class="line">2021/02/23 18:44:57 ERROR Check &#x27;ping&#x27; on &#x27;master1&#x27; has failed for 11 seconds! Message: ERROR: Could not ping</span><br><span class="line">172.20.0.11  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>我们在monitor节点上，再次尝试连接到<code>writer vip 172.20.0.100</code><br>上面，发现已经连接到master2上面了，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.100 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+---------------+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+---------------+  </span><br><span class="line">| master2.mysql |  </span><br><span class="line">+---------------+  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>下面我们看一下slave1和slave2节点主从同步的配置是否，自动切换到master2节点上。分别登录到slave1和slave2节点上执行如下SQL命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from mysql.slave\_master\_info\\G</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看结果如下：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62340114810300.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62340114810300.png"></a></p>
<p>通过下面的截图，可以看出在新的主节点上面执行的插入数据，是可以正常的同步到两个slave从节点上。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62343970188500.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62343970188500.png"></a></p>
<p>下面我们把master1节点重新启动，让MySQL数据库服务恢复。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动master1容器</span>  </span><br><span class="line">docker start mysql-ha-mmm-master1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入master1容器</span>  </span><br><span class="line">docker exec -it mysql-ha-mmm-master1 /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动master1上面的MMM的agent服务</span>  </span><br><span class="line">/etc/init.d/mysql-mmm-agent start</span><br></pre></td></tr></table></figure>

<p>进入monitor节点上，查看各个节点的状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在master1启动后，在monitor节点查看各个节点状态的时候，发现已经不再有<span class="string">&quot;Warning: agent on host master1 is not reachable&quot;</span></span></span><br><span class="line">的警告了。  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/AWAITING_RECOVERY. Roles:  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.122), writer(172.20.0.100)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.111), reader(172.20.0.211)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置master1节点上线</span>  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online master1  </span><br><span class="line">OK: State of &#x27;master1&#x27; changed to ONLINE. Now you can wait some time and check its new roles!</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次查看各个节点的状态，发现master1已经上线了。但是它此时成立备用的主节点了，并且给他分配了一个reader VIP地址。</span>  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/ONLINE. Roles: reader(172.20.0.211)  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.122), writer(172.20.0.100)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.111)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p><strong>MMM高可用验证结果小结：</strong></p>
<ul>
<li><p>master1节点宕机之后，master2节点会接管master1的所有任务。</p>
</li>
<li><p>writer VIP会自动从master1上面转移到master2上面。</p>
</li>
<li><p>两个从节点slave1和slave2会自动的把主从同步的链路从master1切换到master2上面。</p>
</li>
<li><p>如果在master1上除了提供写的服务，还提供可读的服务，也就是为其分配了reader VIP，那么当master1宕机后，这个reader<br>VIP不会丢失，会被迁移到其他任意一个节点上。</p>
</li>
<li><p>在master1重启后，在monitor节点通过命令<code>mmm_control set_online master1</code><br>设置master1节点上线后，master1节点不会接管现有master2的角色，而是作为一个备用主节点集群中提供服务。此时，只有master2节点宕机后，master1节点才会重新成为主节点的角色。</p>
</li>
<li><p>随着master1和master2节点的宕机和恢复，提供写的VIP会在两个节点上来回切换。</p>
</li>
</ul>
<p>对于这个5个服务器组成的高可用集群，如果我们担心MMM的monitor节点是单节点，不是高可用的monitor服务，我们可以在选择一台服务器，在上面部署另外一个monitor服务，使用keepalive组件，保证两个monitor服务至少有一个可用。这样就更加完美了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面就是关于MySQL高可用架构-MMM架构的搭建过程。期间涉及到了MySQL主从同步集群的搭建，我们搭建了一个双主双从的集群，然后基于这个集群，又在每一个节点上面编译安装了MMM插件，在每一个节点上启动了MMM的agent服务。还选择了一台服务器，安装MMM监控服务。</p>
<p>希望对你有所帮助，后续会分享其他高可用架构搭建的方式。</p>
<h1 id="如果您喜欢我的内容，就点击关注吧"><a href="#如果您喜欢我的内容，就点击关注吧" class="headerlink" title="如果您喜欢我的内容，就点击关注吧"></a>如果您喜欢我的内容，就点击关注吧</h1><blockquote>
<p>扫码长按关注交流群获取最新消息，面试手册正式推出啦，打造全网最全，最细面试题</p>
</blockquote>
<p>支持艾宾浩斯记忆，卡片式记忆</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-26/1091289280100.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-26/1091289280100.png"></a></p>
<p>还支持学习统计，轻松查看每天记忆了多少，学习情况，了如指掌</p>
<p>购买地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://store.amazingmemo.com/chapterDetail/1685324709017001">https://store.amazingmemo.com/chapterDetail/1685324709017001</a></p>
<blockquote>
<p>个人微信</p>
</blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/%E4%BA%8C%E7%BB%B4%E7%A0%81/%E6%8E%A8%E5%B9%BF/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230903222821.jpg" title="请加个人微信备注【交流群】" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/%E4%BA%8C%E7%BB%B4%E7%A0%81/%E6%8E%A8%E5%B9%BF/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230903222821.jpg" alt="请加个人微信备注【交流群】"></a></p>
<blockquote>
<p>公众号</p>
</blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/%E4%BA%8C%E7%BB%B4%E7%A0%81/%E6%8E%A8%E5%B9%BF/qrcode_for_gh_de3cbab6482f_430" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/%E4%BA%8C%E7%BB%B4%E7%A0%81/%E6%8E%A8%E5%B9%BF/qrcode_for_gh_de3cbab6482f_430"></a></p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zysicyj.github.io">程序员朱永胜</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zysicyj.github.io/mysql_mmm.html">https://zysicyj.github.io/mysql_mmm.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zysicyj.github.io" target="_blank"></a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://img.xjh.me/random_img.php?return=302" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142337659.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142337659.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142338230.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142338230.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="mysql_mha.html" title="MySQL高可用搭建方案之（MHA）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.xjh.me/random_img.php?return=302" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL高可用搭建方案之（MHA）</div></div></a></div><div class="next-post pull-right"><a href="cd621e01.html" title="MySQL高可用九种方案"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.xjh.me/random_img.php?return=302" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL高可用九种方案</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/aliyun/202308012321669.jpg" onerror="this.onerror=null;this.src='../img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">程序员朱永胜</div><div class="author-info__description">点击积累，终有所获！</div></div><div class="card-info-data site-data is-center"><a href="../archives/"><div class="headline">文章</div><div class="length-num">240</div></a><a href="../tags/"><div class="headline">标签</div><div class="length-num">974</div></a><a href="../categories/"><div class="headline">分类</div><div class="length-num">61</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/zysicyj"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zysicyj" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="../mailto:zysicyj@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142231851.png" rel="external nofollow noreferrer" target="_blank" title="微信"><i class="fas fa-brands fa-weixin" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142242856.jpg" rel="external nofollow noreferrer" target="_blank" title="微信公众号"><i class="fas fa-brands fa-weixin fa-beat" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://blog.csdn.net/njpkhuan" rel="external nofollow noreferrer" target="_blank" title="CSDN"><i class="fa-solid fa-blog fa-beat" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://space.bilibili.com/258577429" rel="external nofollow noreferrer" target="_blank" title="Bilibili"><i class="fa-brands fa-bilibili" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://developer.aliyun.com/profile/uriwrrq5ogjao" rel="external nofollow noreferrer" target="_blank" title="阿里开发者社区"><i class="fa-solid fa-cloud" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://cloud.tencent.com/developer/user/1275095" rel="external nofollow noreferrer" target="_blank" title="腾讯云开发者社区"><i class="fa-regular fa-cloud" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.toutiao.com/c/user/token/MS4wLjABAAAAfLUOYrCr4xBK9g13tFhmHCUYeM8gAzX9QMkSNOCr434" rel="external nofollow noreferrer" target="_blank" title="今日头条"><i class="fa-brands fa-tiktok" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">如果你在使用中遇到问题，请到<a href="/lyb/" style="color:#49b1f5" data-pjax-state="">留言板</a> 进行反馈，你也可以加我个人微信 sheng_chenyuanjie 拉你进群。<div class="social-button"><a class="button--animated" href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/%E4%BA%8C%E7%BB%B4%E7%A0%81/%E6%8E%A8%E5%B9%BF/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230903222821.jpg" rel="external nofollow noreferrer" target="_blank">个人微信 👍</a> <a class="button--animated" href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/%E4%BA%8C%E7%BB%B4%E7%A0%81/%E6%8E%A8%E5%B9%BF/qrcode_for_gh_de3cbab6482f_430" rel="external nofollow noreferrer" target="_blank">公众号 👍</a> <a class="button--animated" href="https://store.amazingmemo.com/chapterDetail/1685324709017001" rel="external nofollow noreferrer" target="_blank">全网最全最细面试题 👍</a> </div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E6%96%87%E5%9C%B0%E5%9D%80"><span class="toc-text">原文地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4-VS-%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-text">集群 VS 高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MMM%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-text">MMM高可用架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFMMM"><span class="toc-text">什么是MMM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MMM%E6%9E%B6%E6%9E%84%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-text">MMM架构的优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MMM%E6%9E%B6%E6%9E%84%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-text">MMM架构的缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAMMM%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-text">如何搭建MMM高可用架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E%E7%9A%84MySQL%E9%9B%86%E7%BE%A4"><span class="toc-text">搭建双主双从的MySQL集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8E%AF%E5%A2%83"><span class="toc-text">准备MySQL数据库环境</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%9B%91%E6%8E%A7%E8%8A%82%E7%82%B9"><span class="toc-text">启动监控节点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7"><span class="toc-text">创建主从同步的数据库用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE%E7%9A%84%E5%90%8C%E6%AD%A5"><span class="toc-text">历史数据的同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E7%BB%84%E4%BB%8E%E5%90%8C%E6%AD%A5"><span class="toc-text">开启组从同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%B8%8E%E4%B8%BB%E7%9A%84%E5%90%8C%E6%AD%A5"><span class="toc-text">配置主与主的同步</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85MMM"><span class="toc-text">安装MMM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9apt-get%E6%BA%90"><span class="toc-text">修改apt-get源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDMMM"><span class="toc-text">下载MMM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85MMM"><span class="toc-text">编译安装MMM</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAMMM%E4%BD%BF%E7%94%A8%E7%9A%84MySQL%E7%94%A8%E6%88%B7"><span class="toc-text">创建MMM使用的MySQL用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9MMM%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">修改MMM的配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8MMM%E6%9C%8D%E5%8A%A1"><span class="toc-text">启动MMM服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81VIP%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">验证VIP访问数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81MMM%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-text">验证MMM的高可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%82%A8%E5%96%9C%E6%AC%A2%E6%88%91%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E5%B0%B1%E7%82%B9%E5%87%BB%E5%85%B3%E6%B3%A8%E5%90%A7"><span class="toc-text">如果您喜欢我的内容，就点击关注吧</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最近更新</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="../today.html" title="Today"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.xjh.me/random_img.php?return=302" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="Today"/></a><div class="content"><a class="title" href="../today.html" title="Today">Today</a><time datetime="2023-10-10T00:42:00.348Z" title="更新于 2023-10-10 08:42:00">2023-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../17a06eac.html" title="【面试题精讲】有哪些方式能创建对象"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.xjh.me/random_img.php?return=302" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="【面试题精讲】有哪些方式能创建对象"/></a><div class="content"><a class="title" href="../17a06eac.html" title="【面试题精讲】有哪些方式能创建对象">【面试题精讲】有哪些方式能创建对象</a><time datetime="2023-10-10T00:40:13.301Z" title="更新于 2023-10-10 08:40:13">2023-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../bd055566.html" title="【面试题精讲】创建一个对象用什么运算符?对象实体与对象引用有何不同?"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.xjh.me/random_img.php?return=302" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="【面试题精讲】创建一个对象用什么运算符?对象实体与对象引用有何不同?"/></a><div class="content"><a class="title" href="../bd055566.html" title="【面试题精讲】创建一个对象用什么运算符?对象实体与对象引用有何不同?">【面试题精讲】创建一个对象用什么运算符?对象实体与对象引用有何不同?</a><time datetime="2023-10-10T00:39:55.416Z" title="更新于 2023-10-10 08:39:55">2023-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../c5cce5bc.html" title="【面试题精讲】引用传递是怎么样的？"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.xjh.me/random_img.php?return=302" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="【面试题精讲】引用传递是怎么样的？"/></a><div class="content"><a class="title" href="../c5cce5bc.html" title="【面试题精讲】引用传递是怎么样的？">【面试题精讲】引用传递是怎么样的？</a><time datetime="2023-10-10T00:39:55.405Z" title="更新于 2023-10-10 08:39:55">2023-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../c61191b5.html" title="【面试题精讲】什么是序列化和反序列化?"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.xjh.me/random_img.php?return=302" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="【面试题精讲】什么是序列化和反序列化?"/></a><div class="content"><a class="title" href="../c61191b5.html" title="【面试题精讲】什么是序列化和反序列化?">【面试题精讲】什么是序列化和反序列化?</a><time datetime="2023-10-10T00:39:55.393Z" title="更新于 2023-10-10 08:39:55">2023-10-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By 程序员朱永胜</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">欢迎订阅我的公众号【程序员朱永胜】</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="js/utils.js"></script><script src="js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://zysicyj.zeabur.app',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(init)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://zysicyj.zeabur.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
      GLOBAL_CONFIG_SITE.isPost && getCount()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script>(() => {
  window.$crisp = [];
  window.CRISP_WEBSITE_ID = "6180e08a-324f-4622-9954-c278ba178759";
  (function () {
    d = document;
    s = d.createElement("script");
    s.src = "https://client.crisp.chat/l.js";
    s.async = 1;
    d.getElementsByTagName("head")[0].appendChild(s);
  })();
  $crisp.push(["safe", true])

  const isChatBtn = true
  const isChatHideShow = false

  if (isChatBtn) {
    const open = () => {
      $crisp.push(["do", "chat:show"])
      $crisp.push(["do", "chat:open"])
    }

    const close = () => {
      $crisp.push(["do", "chat:hide"])
    }

    close()
    $crisp.push(["on", "chat:closed", function() {
      close()
    }])

    window.chatBtnFn = () => {
      $crisp.is("chat:visible") ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        $crisp.push(["do", "chat:hide"])
      },
      show: () => {
        $crisp.push(["do", "chat:show"])
      }
    }
  }
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="../js/search/local-search.js"></script></div></div></body></html>