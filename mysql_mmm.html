<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>MySQL 高可用搭建方案之（MMM） | </title><meta name="author" content="程序员朱永胜"><meta name="copyright" content="程序员朱永胜"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="MySQL 高可用搭建方案之（MMM）"><meta name="application-name" content="MySQL 高可用搭建方案之（MMM）"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="MySQL 高可用搭建方案之（MMM）"><meta property="og:url" content="https://blog.zysicyj.top/mysql_mmm.html"><meta property="og:site_name" content=""><meta property="og:description" content="有的时候博客内容会有变动，首发博客是最新的，其他博客地址可能会未同步, 认准https:&amp;#x2F;&amp;#x2F;blog.zysicyj.top   注意：这篇转载文章，非原创  原文地址  前言MySQL 的高可用有很多种，有我们经常说的 MMM 架构、MHA 架构、MGR 架构。在这一篇文章中我们先讨论 MMM"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://img.xjh.me/random_img.php?return=302&amp;_r_=c24444d6-3276-e25b-a1c6-4d479d0cfabb"><meta property="article:author" content="程序员朱永胜"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.xjh.me/random_img.php?return=302&amp;_r_=c24444d6-3276-e25b-a1c6-4d479d0cfabb"><meta name="description" content="有的时候博客内容会有变动，首发博客是最新的，其他博客地址可能会未同步, 认准https:&amp;#x2F;&amp;#x2F;blog.zysicyj.top   注意：这篇转载文章，非原创  原文地址  前言MySQL 的高可用有很多种，有我们经常说的 MMM 架构、MHA 架构、MGR 架构。在这一篇文章中我们先讨论 MMM"><link rel="shortcut icon" href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/aliyun/202308012321669.jpg"><link rel="canonical" href="https://blog.zysicyj.top/mysql_mmm.html"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-9343722716173603',
  enable_page_level_ads: 'true'
});</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?16bc6435aa26c2ae803ad0e62e4f5fa8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3Is8EMFcqgGHzmLJ","LingQueMonitorID":"3Is8EMFcqgGHzmLJ"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":1},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 程序员朱永胜","link":"链接: ","source":"来源: ","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: {"enable":true,"delay":100,"shiftDelay":200},
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '',
  title: 'MySQL 高可用搭建方案之（MMM）',
  postAI: '',
  pageFillDescription: '前言, 什么是 MMM, MMM 架构的优点, MMM 架构的缺点, 搭建双主双从的 MySQL 集群 ,  准备 MySQL 数据库环境 , 启动监控节点, 创建主从同步的数据库用户 , 历史数据的同步 , 开启组从同步 , 配置主与主的同步 , 安装 MMM, 修改 apt-get 源 , 下载 MMM, 编译安装 MMM, 创建 MMM 使用的 MySQL 用户 , 修改 MMM 的配置文件, 启动 MMM 服务 , 验证 VIP 访问数据库 , 验证 MMM 的高可用 , 总结 有的时候博客内容会有变动首发博客是最新的其他博客地址可能会未同步认准注意这篇转载文章非原创原文地址前言的高可用有很多种有我们经常说的架构架构架构在这一篇文章中我们先讨论架构的高可用后续在分析和其中的有点类似于推出的集群集群高可用在数据库中什么是集群什么是高可用最早我理解的是只要有了读写分离的组从集群架构就是拥有高可用的架构了现在想想当初的想法是多么的天真集群和的高可用是两个概念我们不能把他们混为一谈集群是指你多台数据库实例有一个可以提供写多个提供读或者有多个可以写多个可以读比如我们配置了读写分离的一主多从的集群架构或者双主多从的集群架构此时我们只是有了的集群在读写性能上有锁提升但是此时并不是一个高可用的架构高可用是指在任意一个时刻我们的都可以提供读写的服务不会因为某一个数据库实例宕机而导致数据不能正常读写此时才是高可用从某种意义上来说高可用要在集群的基础上才可以实现也就是说要想高可用必须先把集群搭建起来有了的集群才可以谈论的高可用没有的集群谈的高可用犹如空中楼阁拿我们前面说的双主多从的集群架构来说两个主在同一个时间点若只有一个主对外提供写的服务此时如果其中一个主宕机另外一个主可以顶替原先的主对外提供写的服务同时其他的从可以把同步的数据源切换到新的主上面来这样的一个集群就是一个高可用的架构有了的集群并不一定就有的高可用但是如果有了的高可用那么此时它一定是一个集群高可用需要在集群的基础上来配合其他组件才能实现高可用架构什么是所谓的只是取其中的三个开头的单词简写它是多主复制管理器基于实现关于主主复制配置的监控故障转移和管理的一套可伸缩的脚本套件在任何时候只有一个节点可以被写入也能对从服务器进行读负载均衡所以可以用它来在一组用于复制的服务器启动虚拟除此之外它还有实现数据备份节点之间重新同步功能的脚本本身没有提供的解决方案通过方案能实现服务器的故障转移从而实现的高可用不仅能提供浮动的功能如果当前的主服务器挂掉后会将你后端的从服务器自动转向新的主服务器进行同步复制不用手工更改同步配置从字面来理解就是它有两个节点并且实现了这两个节点的高可用它的架构如下所示主要功能由下面三个脚本提供负责所有的监控工作的监控守护进程决定节点的移除进程定时心跳检测失败则将浮动到另外一台运行在服务器上的代理守护进程通过简单远程服务集提供给监控节点通过命令行管理进程在整个监管过程中需要在中添加相关授权用户授权的用户包括一个用户和一个用户如果想使用的备份工具则还要添加一个用户架构的优点可以兼容不同系列的来做高可用比如有官方社区版本有版本的有版本的这样的集群可以可以使用架构来做高可用高可用性扩展性好出现故障自动切换对于主主同步在同一时间只提供一台数据库写操作保证的数据的一致性当主服务器挂掉以后另一个主立即接管其他的从服务器能自动切换不用人工干预架构的缺点是一种比较老的高可用实现方式因为社区不活跃所以目前已经没有人在维护这个组件了只能基于日之点的主从复制集群架构来做高可用不支持基于的主从复制集群架构这也是因为社区活跃没有维护这个组件导致不支持数据不能保证的一致性这个是以为它在做故障转移的时候实现的方式所导致的如果对于数据需要强一致性则不能选择高可用架构可以考虑高可用架构节点是单点不过这个可以结合或者做成高可用至少三个节点个个对主机的数量有要求在读写非常繁忙的业务系统下表现不是很稳定可能会出现复制延时切换失效等问题方案并不太适应于对数据安全性要求很高并且读写繁忙的环境中需要实现读写分离还需要在前端编写读写分离程序或者结合数据库中间件如来解决如何搭建高可用架构要想实现高可用架构我们先来搭建一个双主双从的集群然后在这个集群的基础上来完成高可用的架构我们准备搭建的高可用架构的网络拓扑如下所示需要注意的是其中的这几个不需要我们自己创建服务会自动的在各个节点分配这些其中的绿色字体它并不会严格的按照我们下图中分配是主机来分配而是随机的将这个分布到个数据库节点上但是红色字体的只会在或上面随着和节点宕机和恢复来回切换搭建双主双从的集群准备数据库环境我们使用来启动个容器作为双主双从的四个数据库实例容器镜像的名称为这个镜像是上面官方提供的镜像它是基于版本制作的容器镜像所以我们的数据库服务器可以任务是一个版本的系统为了方便管理我们先创建一个虚拟网段然后在启动四个数据库的时候指定数据库服务器的地址并且使用这个网段创建网段的命令如下我们使用下面的四条命令启动个数据库实例这里我们把每一个数据库的配置文件已经在本地配置好然后通过数据卷的方式挂载到容器中这样我们启动的数据库实例就会按照我们配置的配置文件来启动并配置我们的数据库实例启动节点启动节点启动节点启动节点这里解释一下后面几个重要的参数和含义指定容器运行的时候使用的网段指定容器的主机名称指定容器使用的地址默认容器运行的时候没有增加额外的的功能这里我们要增加上的功能否则我们不能再启动后的容器内使用命令增加虚拟否则会有如下错误提示指定容器的名称为后面我们在停止或重启容器的时候可以通过这个名称来操作容器以进程的方式运行容器把本地的目录挂载到容器中的目录下向容器内传入参数我们指定数据库用户的密码也为向容器内传入参数这里我们指定的容器中使用的系统的时区为上海时间我们指定容器中的端口映射到我们本地为这样我们在本地访问服务的时候就可以通过端口来访问这个是我们要运行的容器的名称和版本如果本地没有这个容器名称和版本则会从中自动拉取这个镜像名称和版本到本地然后再启动这个镜像容器启动后我们可以查看启动后的结果如下下面我们查看每一个数据库容器的文件中的地址的文件如下的文件如下的文件如下的文件如下上面我们启动的四个数据库实例我们还需要一个监控节点下面启动一个监控节点用于安装的监控服务为了和其他环境一致这里我们也使用上面的镜像如下是启动一个新的容器这个容器我们不在挂载的配置文件了因为这个数据库我们不会使用我们只是在这个容器中安装的监控服务我们此时把这个数据库容器当成一个版本的虚拟机来使用启动监控节点查看这个监控节点的文件如下创建主从同步的数据库用户在组从同步的时候从需要使用一个指定的用户去连接到主上面同步主上面的日志所以我们需要在我们的主上面创建好这样的一个用户因为在宕机之后组件会将提升为新的主库所以需要在和上面都创建一个这样的用户也就是下的命令需要在两个节点上都执行一下历史数据的同步如果我们并不是基于一个新的集群环境来搭建而是基于一个已经运行了一段时间的数据库来做集群此时我们需要把选定的节点上面的数据先使用命令导出为文件然后再把这个文件导入到所有的节点上去然后在可以开始下面的任务在上面执行的导出的命令示例如下在所有的节点上执行的导入数据的命令示例如下但是我们是基于一个崭新的环境来做的不涉及到历史数据的问题所以这一步我们可以省略开启组从同步在所有的上面执行如下命令此时的文件和日志点的位置可以在上面使用命令查看或者查看导出数据的时候生成的文件在节点上执行导出命令的时候我们指定的这个参数会在导出的文件中标记当前节点上日志的文件名称和日志偏移量开启组从同步查看同步状态配置主与主的同步上面我们配置好了的同步我们还需要在和直接配置互相同步对方现在上面配置作为它的主库参考上面和上面的配置执行如下命令然后再配置到的同步此时我们需要查看一下上面的日志名称和日志偏移量是多少使用如下命令查看然后我们登录到上面执行如下命令配置作为的主库验证双主双从同步的效果如下安装修改源在下载之前我们先修改一下源然后更新一下源如下所示因为此时的容器中没有命令所以我们使用的方式去更新的源注意在更新镜像源的时候要根据自己的系统的版本我的系统的版本是版本所以你要根据自己的系统版本网上找到对应的镜像地址接着我们更新一下系统更新完成之后我们先安装一下我们经常用到的几个命令下载推荐使用源码来安装这样可以在任何系统版本上面进行安装例如等等不用因为系统版本的问题找对应的包找对应的包通过如下步骤来获取的源码登录的官方网站然后点击跟多关于下载与软件介绍的连接此时我们会进入如下页面然后点击软件包连接接着我们会进入如下页面根据选项输入点击搜索按钮点击上面的搜索按钮后进入如下页面然后我们点击页面中的系统的版本选择版本因为是比较老的一种考可用架构在最新的系统中已经没有这样的软件包了所以我们选择老版本的版本这个版本中包含的源码点击完成之后进入如下页面此时我们已经搜索到了的软件点击其中任何一个链接进入详细页面进入如下的页面我们选择下载源码文件或者我们可以右键复制下载地址使用命令下载源码到服务器上如果要下载文件可以点击上面图片中的硬件架构下面的连接进入下面页面后选择对应的距离我们最近镜像地址我选择的为这个镜像地址然后复制下载链接地址使用下载即可这里贴出如下的下载示例编译安装我们是使用的的容器镜像来启动的集群而这个从上面拉取的官方版本的镜像是基于系统来制作的所以我们此次安装软件需要基于系统来安装下载好的如下所示解压并且安装但是在安装之前先安装一下它的依赖包使用如下命令来安装安装的命令和过程如下如果在安装的时候提示没有命令则需要先安装命令安装的时候如果是或系统使用如下命令安装如果是或系统则使用如下的命令来安装以上编译安装需要在每一个节点都执行包括两个节点和两个节点还有监控节点也要安装安装完之后我们需要注意一下几个目录这是我们使用服务的基础各种配置文件所在目录服务日志文件所在目录的服务的日志文件的服务的日志文件各种脚本所在目录客户端各种脚本所在目录监控端各种脚本所在目录工具包脚本所在目录启动和关闭服务的脚本文件创建使用的用户监控用和客户端用户在所有的节点上都要创建这两个用户如果已经配置组从同步在上创建就其他节点会自动同步这两个创建好的用户到其他节点需要注意的是这两个用户的权限不同结合前面我们配置组从同步的哪一个用户我们来对比一下监控使用的用户拥有权限就可以客户单使用的用拥有权限组从同步使用的用户拥有权限即可最后的用户在四个节点上面的结果如下图所示修改的配置文件所有的配置文件都在如下目录中配置文件所有个节点中的配置文件都修改为如下所示的内容网卡的名称各个主机上面网络设备的名称主从复制用户名和密码服务使用的用户名和密码的配置信息的配置信息的配置信息的配置信息写虚拟的配置信息指定可写的主机名称读虚拟的配置信息指定可以提供读服务的主机名称下面的和主键名称不一定是一一对应的是随机分布到各个可读节点的如果提供多个有可能一个节点被分配多个这样也是支持的上面的中配置的可读节点可以根据自己的需求来配置这里我把都作为可读的节点当然可以把主节点去掉只配置三个节点这里的也是我们指定的的值我们可以配置多个最好是的个数和上面的的数目一致表示每一个提供读的节点分配一个配置文件每一个节点上面的配置文件中都在第行中修改一下主机名称下面给出节点的配置如下其他各个节点也需要作出对应的修改只要把改为对应的主机名称即可配置文件在节点上修改配置文件修改内容如下所示其他四个节点不需要对这个文件做修改网关地址和各个节点的物理地址用于监控各个节点的状态是否可用服务使用中的用户名称和密码值为非模式为的时候表示模式模式下会在日志文件中生成更多日志信息启动服务客户端服务相关命令如下客户端启动后日志存放在文件中监控端服务相关命令如下监控端启动后日志存放在文件中监控状态有一个管理命令它的使用帮助如下所示常用的维护节点状态的命令如下下面分别在四个节点上执行如下命令启动并查看的客户端服务主节点上启动和查看的客户端服务如下主节点上启动和查看的客户端服务如下主节点上启动和查看的客户端服务如下主节点上启动的客户端服务如下下面在监控节点上执行如下命令启动并查看的监控服务节点上启动和查看的监控端服务如下在节点查看监控的状态问题排查服务不能正常启动当在节点启动监控服务后监控服务一会就异常退出了原因是在使用启动集群节点的时候没有使用参数没有这个参数就没有办法在容器只用使用虚拟的功能在删除容器后增加参数重新运行后才运行起来后来又发现节点启监控服务器仍然失败查看日志如下所示修改配置文件中的的值为表示以的模式运行服务此时我们再重新启动服务查看输出的详细错误日志如下于是去修改了文件在第行增加如下内容保存退出重新启动服务然后再次重启服务启动成功然后把配置文件中的的值再次修改为关闭模式再次重启服务此时查看服务的日志内容如下问题排查虚拟不能再各个节点生成启动后发现不能通过访问数据库去各个节点使用或者命令查看发现没有对应的生成查看了各个节点服务的日志文件发现如下错误信息经过排查发现是在设置的时候失败设置客户端的脚本如下执行上面的脚本发现如下错误提示我们需要在中安装包安装的时候为了提高速度我们修改一下安装模块的时候使用的镜像源修改安装包的时候使用的镜像源参考如下方式修改其中各个命令的含义如下查看的当前的镜像源添加阿里的镜像源提交对镜像源的修改安装包经过上面的安装方式发现安装失败于是下载源码自己编译安装这个包参考如下命令顺序来编译安装下载源码文件解压下载后的文件进入下载目录执行编译执行安装上面安装包的操作需要在除了节点的四个节点上都执行安装一下最后所有节点的地址和地址如下所示验证访问数据库当我们的客户段服务在四个数据库实例中启动并且监控服务在节点启动之后我们在节点上面尝试使用各个看能否正常连接到数据库验证的结果如下验证的高可用我们把节点上面的服务停止掉来验证一下是否会把主从同步的源头从切换为上面并且我们在节点上仍然可以通过去连接到上停止节点上面的服务在节点上执行如下命令接着我们在节点上查看监控各个节点服务的状态发现节点以及下线了并且我们的已经从原先的节点迁移到节点上了如下所示此时我们看到上面的地址信息如下已经迁移到了主机上了在节点上查看的监控服务器的日志信息如下我们在节点上再次尝试连接到上面发现已经连接到上面了如下所示下面我们看一下和节点主从同步的配置是否自动切换到节点上分别登录到和节点上执行如下命令查看结果如下通过下面的截图可以看出在新的主节点上面执行的插入数据是可以正常的同步到两个从节点上下面我们把节点重新启动让数据库服务恢复启动容器进入容器启动上面的的服务进入节点上查看各个节点的状态在启动后在节点查看各个节点状态的时候发现已经不再有的警告了设置节点上线再次查看各个节点的状态发现已经上线了但是它此时成立备用的主节点了并且给他分配了一个地址高可用验证结果小结节点宕机之后节点会接管的所有任务会自动从上面转移到上面两个从节点和会自动的把主从同步的链路从切换到上面如果在上除了提供写的服务还提供可读的服务也就是为其分配了那么当宕机后这个不会丢失会被迁移到其他任意一个节点上在重启后在节点通过命令设置节点上线后节点不会接管现有的角色而是作为一个备用主节点集群中提供服务此时只有节点宕机后节点才会重新成为主节点的角色随着和节点的宕机和恢复提供写的会在两个节点上来回切换对于这个个服务器组成的高可用集群如果我们担心的节点是单节点不是高可用的服务我们可以在选择一台服务器在上面部署另外一个服务使用组件保证两个服务至少有一个可用这样就更加完美了总结上面就是关于高可用架构架构的搭建过程期间涉及到了主从同步集群的搭建我们搭建了一个双主双从的集群然后基于这个集群又在每一个节点上面编译安装了插件在每一个节点上启动了的服务还选择了一台服务器安装监控服务希望对你有所帮助后续会分享其他高可用架构搭建的方式程序员朱永胜',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-17 06:46:22',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="atom.xml" title="" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.zysicyj.top/" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2748ef34.jpg" alt="个人主页"/><span class="back-menu-item-text">个人主页</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">写作软件</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://editor.runjs.cool/post?id=demo" title="Mdx"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4296739868700.png" alt="Mdx"/><span class="back-menu-item-text">Mdx</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://openwrite.cn/" title="OpenWrite"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://openwrite.cn/logo.png" alt="OpenWrite"/><span class="back-menu-item-text">OpenWrite</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jetbrains.com/zh-cn/writerside/" title="WriteSide"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="data:image/jpeg;base64,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" alt="WriteSide"/><span class="back-menu-item-text">WriteSide</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">开发工具</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jetbrains.com/zh-cn/idea/" title="idea"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4576710485000.png" alt="idea"/><span class="back-menu-item-text">idea</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jetbrains.com/zh-cn/datagrip/" title="DataGrip"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4604435065400.png" alt="DataGrip"/><span class="back-menu-item-text">DataGrip</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4663369180700.png" title="WebStorm"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4604435065400.png" alt="WebStorm"/><span class="back-menu-item-text">WebStorm</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html" title="微信开发者工具"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4743988475500.png" alt="微信开发者工具"/><span class="back-menu-item-text">微信开发者工具</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html" title="HBuilder"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://www.dcloud.io/hbuilderx.html" alt="HBuilder"/><span class="back-menu-item-text">HBuilder</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://mobaxterm.mobatek.net/" title="MobaXterm"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4849682167700.png" alt="MobaXterm"/><span class="back-menu-item-text">MobaXterm</span></a></div></div></div></div><a id="site-name" href="index.html" accesskey="h"><div class="title"></div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)" rel="external nofollow noreferrer">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="index.html"><i class="fas fa-home faa-tada"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-link faa-tada"></i><span> 目录</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="fas fa-archive faa-tada"></i><span> 时间轴</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="fas fa-folder-open faa-tada"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-list faa-tada"></i><span> 清单</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/movies/"><i class="fas fa-video faa-tada"></i><span> 电影</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/books/"><i class="fas fa-book faa-tada"></i><span> 阅读</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/songs/"><i class="fas fa-music faa-tada"></i><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="fa-brands fa-bilibili faa-tada"></i><span> 追番</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/cinemas/"><i class="fa-brands fa-bilibili faa-tada"></i><span> 追剧</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="fas fa-link faa-tada"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/gallery/"><i class="fas fa-solid fa-image faa-tada"></i><span> 相册集</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/love/static/index.html"><i class="fas fa-heart faa-tada"></i><span> Love</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="fa-solid fa-user faa-tada"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="fa-solid  fa-comment faa-tada"></i><span> 闲言碎语</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142337659.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="wechat" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142337659.png"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142338230.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="alipay" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142338230.png"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="tags/2024%E5%B9%B4/" style="font-size: 1.05rem;">2024年<sup>1</sup></a><a href="tags/2024%E5%B9%B47%E6%9C%88/" style="font-size: 1.05rem;">2024年7月<sup>1</sup></a><a href="tags/2%E6%97%A5/" style="font-size: 1.05rem;">2日<sup>1</sup></a><a href="tags/7%E6%9C%88/" style="font-size: 1.05rem;">7月<sup>1</sup></a><a href="tags/CSS/" style="font-size: 1.05rem;">CSS<sup>2</sup></a><a href="tags/Docker-Compose%E5%AE%89%E8%A3%85Space/" style="font-size: 1.05rem;">Docker Compose安装Space<sup>1</sup></a><a href="tags/GithubPages/" style="font-size: 1.05rem;">GithubPages<sup>3</sup></a><a href="tags/Github%E9%85%8D%E7%BD%AE/" style="font-size: 1.05rem;">Github配置<sup>2</sup></a><a href="tags/Hexo/" style="font-size: 1.05rem;">Hexo<sup>7</sup></a><a href="tags/NR/" style="font-size: 1.05rem;">NR<sup>8</sup></a><a href="tags/Redis%E9%9B%86%E7%BE%A4/" style="font-size: 1.05rem;">Redis集群<sup>1</sup></a><a href="tags/bug/" style="font-size: 1.05rem;">bug<sup>3</sup></a><a href="tags/github/" style="font-size: 1.05rem;">github<sup>1</sup></a><a href="tags/gossip%E5%8D%8F%E8%AE%AE/" style="font-size: 1.05rem;">gossip协议<sup>1</sup></a><a href="tags/hexo/" style="font-size: 1.05rem;">hexo<sup>1</sup></a><a href="tags/nari/" style="font-size: 1.05rem;">nari<sup>22</sup></a><a href="tags/xxc/" style="font-size: 1.05rem;">xxc<sup>1</sup></a><a href="tags/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" style="font-size: 1.05rem;">个人博客<sup>2</sup></a><a href="tags/%E5%85%8D%E8%B4%B9/" style="font-size: 1.05rem;">免费<sup>2</sup></a><a href="tags/%E5%85%8D%E8%B4%B9%E6%9C%8D%E5%8A%A1/" style="font-size: 1.05rem;">免费服务<sup>1</sup></a><a href="tags/%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.05rem;">内存数据库<sup>1</sup></a><a href="tags/%E5%8D%95%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">单线程<sup>1</sup></a><a href="tags/%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0/" style="font-size: 1.05rem;">发布文章<sup>2</sup></a><a href="tags/%E5%95%86%E5%93%81/" style="font-size: 1.05rem;">商品<sup>9</sup></a><a href="tags/%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" style="font-size: 1.05rem;">多路复用<sup>1</sup></a><a href="tags/%E5%AE%89%E8%A3%85Hexo/" style="font-size: 1.05rem;">安装Hexo<sup>2</sup></a><a href="tags/%E6%90%AD%E5%BB%BA/" style="font-size: 1.05rem;">搭建<sup>2</sup></a><a href="tags/%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/" style="font-size: 1.05rem;">数据同步<sup>1</sup></a><a href="tags/%E6%97%A5%E8%AE%B0/" style="font-size: 1.05rem;">日记<sup>14</sup></a><a href="tags/%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97/" style="font-size: 1.05rem;">更新日志<sup>10</sup></a><a href="tags/%E6%A7%BD%E5%88%86%E9%85%8D/" style="font-size: 1.05rem;">槽分配<sup>1</sup></a><a href="tags/%E7%9F%A5%E5%90%8D%E9%A1%B9%E7%9B%AE-Redis/" style="font-size: 1.05rem;">知名项目/Redis<sup>1</sup></a><a href="tags/%E7%BD%91%E7%AB%99/" style="font-size: 1.05rem;">网站<sup>2</sup></a><a href="tags/%E7%BD%91%E7%AB%99%E6%90%AD%E5%BB%BA/" style="font-size: 1.05rem;">网站搭建<sup>1</sup></a><a href="tags/%E8%8A%82%E7%82%B9%E9%80%9A%E4%BF%A1/" style="font-size: 1.05rem;">节点通信<sup>1</sup></a><a href="tags/%E8%AE%BF%E9%97%AE/" style="font-size: 1.05rem;">访问<sup>2</sup></a><a href="tags/%E8%B5%84%E6%BA%90/" style="font-size: 1.05rem;">资源<sup>9</sup></a><a href="tags/%E9%85%8D%E7%BD%AEhexo-deployer-git/" style="font-size: 1.05rem;">配置hexo-deployer-git<sup>2</sup></a><a href="tags/%E9%9B%86%E7%BE%A4%E5%88%86%E7%89%87/" style="font-size: 1.05rem;">集群分片<sup>1</sup></a><a href="tags/%E9%AB%98%E6%80%A7%E8%83%BD/" style="font-size: 1.05rem;">高性能<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">66</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">27</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);" rel="external nofollow noreferrer"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a></div></div><h1 class="post-title" itemprop="name headline">MySQL 高可用搭建方案之（MMM）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-09-10T16:48:40.000Z" title="发表于 2023-09-10 16:48:40">2023-09-10</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-01-17T06:46:22.454Z" title="更新于 2025-01-17 06:46:22">2025-01-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">12.4k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>56分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL 高可用搭建方案之（MMM）"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为南京"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>南京</span></div></div></div><article class="post-content" id="article-container" itemscope itemtype="https://blog.zysicyj.top/mysql_mmm.html"><header><h1 id="CrawlerTitle" itemprop="name headline">MySQL 高可用搭建方案之（MMM）</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">程序员朱永胜</span><time itemprop="dateCreated datePublished" datetime="2023-09-10T16:48:40.000Z" title="发表于 2023-09-10 16:48:40">2023-09-10</time><time itemprop="dateCreated datePublished" datetime="2025-01-17T06:46:22.454Z" title="更新于 2025-01-17 06:46:22">2025-01-17</time></header><div id="readmore-container"><link rel="stylesheet external nofollow noreferrer" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><blockquote>
<p>有的时候博客内容会有变动，首发博客是最新的，其他博客地址可能会未同步, 认准<code>https://blog.zysicyj.top</code></p>
</blockquote>
<blockquote>
<p>注意：这篇转载文章，非原创</p>
</blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.modb.pro/db/74005">原文地址</a></p>
<hr>
<h2 id="前言"><a href="# 前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL 的高可用有很多种，有我们经常说的 MMM 架构、MHA 架构、MGR 架构。在这一篇文章中我们先讨论 MMM 架构的高可用，后续在分析 MHA 和 MGR，其中的 MGR 有点类似于 percona 推出的 PXC 集群</p>
<p>集群 VS 高可用</p>
<hr>
<p>在 MySQL 数据库中，什么是集群？什么是高可用？最早我理解的是只要有了读写分离的组从集群架构，就是拥有高可用的架构了。现在想想，当初的想法是多么的天真。MySQL 集群和 MySQL 的高可用是两个概念，我们不能把他们混为一谈。</p>
<p>集群是指你多台 MySQL 数据库实例，有一个可以提供写，多个提供读、或者有多个可以写，多个可以读。比如我们配置了读写分离的一主多从的集群架构，或者双主多从的集群架构。此时，我们只是有了 MySQL 的集群，在读写性能上有锁提升，但是此时并不是一个高可用的 MySQL 架构。</p>
<p>高可用是指在任意一个时刻，我们的 MySQL 都可以提供读写的服务，不会因为某一个 MySQL 数据库实例宕机而导致 MySQL 数据不能正常读写，此时才是高可用。从某种意义上来说，高可用要在集群的基础上才可以实现，也就是说，要想高可用，必须先把集群搭建起来。有了 MySQL 的集群，才可以谈论 MySQL 的高可用，没有 MySQL 的集群，谈 MySQL 的高可用犹如空中楼阁。</p>
<p>拿我们前面说的双主多从的 MySQL 集群架构来说，两个主在同一个时间点，若只有一个主对外提供写的服务，此时如果其中一个主宕机，另外一个主可以顶替原先的主对外提供写的服务，同时其他的从可以把同步的数据源切换到新的主上面来，这样的一个集群就是一个高可用的架构。</p>
<p>有了 MySQL 的集群，并不一定就有 MySQL 的高可用。但是如果有了 MySQL 的高可用，那么此时它一定是一个 MySQL 集群。高可用需要在集群的基础上来配合其他组件才能实现。</p>
<p>MMM 高可用架构</p>
<hr>
<h3 id="什么是 MMM"><a href="# 什么是 MMM" class="headerlink" title="什么是 MMM"></a>什么是 MMM</h3><p>所谓的 MMM 只是：<strong>M</strong>ulti-<strong>M</strong>aster Replication <strong>M</strong>anager for<br>MySQL，取其中的三个 M 开头的单词简写。它是 mysql 多主复制管理器，基于 perl 实现，关于 mysql 主主复制配置的监控、故障转移和管理的一套可伸缩的脚本套件（在任何时候只有一个节点可以被写入），MMM 也能对从服务器进行读负载均衡，所以可以用它来在一组用于复制的服务器启动虚拟 ip，除此之外，它还有实现数 <br> 据备份、节点之间重新同步功能的脚本。</p>
<p>MySQL 本身没有提供 replication failover 的解决方案，通过 MMM 方案 <br> 能实现服务器的故障转移，从而实现 mysql 的高可用。MMM 不仅能提供浮动 IP 的功能，如果当前的主服务器挂掉后，会将你后端的从服务器自动转向新的主服务器进行同步复制，不用手工更改同步配置。</p>
<p>从字面来理解就是它有两个 master 节点，并且实现了这两个 master 节点的高可用。它的架构如下所示：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62153149517400.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62153149517400.png"></a></p>
<p>MMM 主要功能，由下面三个脚本提供：</p>
<ul>
<li><p>mmm_mond 负责所有的监控工作的监控守护进程，决定节点的移除(mmm_mond 进程定 时心跳检测，失败则将 write<br>ip 浮动到另外一台 master)</p>
</li>
<li><p>mmm_agentd 运行在 mysql 服务器上的代理守护进 程，通过简单远程服务集提供给监控节点</p>
</li>
<li><p>mmm_control 通过命令行管理 mmm_mond 进程 在整个监管过程中，<br>需要在 mysql 中添加相关授权用户，授权的用户包括一个 mmm_monitor 用户和一个 mmm_agent 用户，如果想使用 mmm 的备份工具则还要添加一个 mmm_tools 用户。</p>
</li>
</ul>
<h3 id="MMM 架构的优点"><a href="#MMM 架构的优点" class="headerlink" title="MMM 架构的优点"></a>MMM 架构的优点</h3><ul>
<li><p>可以兼容不同系列的 MySQL 来做高可用。比如有 MySQL 官方社区版本，有 percona 版本的，有 MariaDB 版本的 MySQL。这样的集群可以可以使用 MMM 架构来做高可用。</p>
</li>
<li><p>高可用性，扩展性好，出现故障自动切换，对于主主同步，在同一时间只提供一台数据库写操作，保证 的数据的一致性。</p>
</li>
<li><p>当主服务器挂掉以后，另一个主立即接管，其他的从服务器能自动切换，不用人工干预。</p>
</li>
</ul>
<h3 id="MMM 架构的缺点"><a href="#MMM 架构的缺点" class="headerlink" title="MMM 架构的缺点"></a>MMM 架构的缺点</h3><ul>
<li><p>是一种比较老的 MySQL 高可用实现方式，因为社区不活跃，所以目前已经没有人在维护这个组件了。</p>
</li>
<li><p>只能基于日之点的主从复制集群架构来做高可用，不支持基于 GTID 的主从复制集群架构。这也是因为社区活跃，没有维护这个组件导致不支持 GTID。</p>
</li>
<li><p>数据不能保证 100% 的一致性，这个是以为它在做故障转移的时候实现的方式所导致的。如果对于数据需要强一致性，则不能选择 MMM 高可用架构，可以考虑 MHA 高可用架构。</p>
</li>
<li><p>monitor 节点是单点，不过这个可以结合 keepalived 或者 haertbeat 做成高可用。</p>
</li>
<li><p>至少三个节点，2 个 master，1 个 slave，对主机的数量有要求，</p>
</li>
<li><p>在读写非常繁忙的业务系统下表现不是很稳定，可能会出现复制延时、切换失效等问题。</p>
</li>
<li><p>MMM 方案并不太适应于对数据安全性要求很高，并且读、写 繁忙的环境中。</p>
</li>
<li><p>需要实现读写分离，还需要在前端编写读写分离程序，或者结合数据库中间件如 mycat 来解决。</p>
</li>
</ul>
<p>如何搭建 MMM 高可用架构</p>
<hr>
<p>要想实现 MMM 高可用架构，我们先来搭建一个双主双从的 MySQL 集群，然后在这个集群的基础上来完成 MMM 高可用的架构。</p>
<p>我们准备搭建的 MySQL-MMM 高可用架构的网络拓扑如下所示：需要注意的是其中的 VIP，这几个 IP 不需要我们自己创建，MMM 服务会自动的在各个节点分配这些 VIP。其中的绿色字体 read<br>vip，它并不会严格的按照我们下图中分配是主机来分配，而是随机的将这 4 个 read vip 分布到 4 个数据库节点上，但是红色字体的 write<br>vip 只会在 master1 或 master2 上面随着 master1 和 master2 节点宕机和恢复来回切换。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62165973507400.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62165973507400.png"></a></p>
<h3 id="搭建双主双从的 MySQL 集群"><a href="# 搭建双主双从的 MySQL 集群" class="headerlink" title="搭建双主双从的 MySQL 集群"></a>搭建双主双从的 MySQL 集群 </h3><h4 id="准备 MySQL 数据库环境"><a href="# 准备 MySQL 数据库环境" class="headerlink" title="准备 MySQL 数据库环境"></a> 准备 MySQL 数据库环境 </h4><p> 我们使用 docker 来启动 4 个 MySQL 容器，作为双主双从的四个 MySQL 数据库实例。容器镜像的名称为 <code>mysql:5.7.31</code><br>，这个镜像是 docker hub 上面 MySQL 官方提供的镜像，它是基于<code>Debian buster</code><br> 版本制作的 MySQL 容器镜像。所以，我们的 MySQL 数据库服务器，可以任务是一个 minimal 版本的 Debian 系统。</p>
<p>为了方便管理，我们先创建一个 docker 虚拟网段，然后在启动四个 MySQL 数据库的时候，指定数据库服务器的 IP 地址并且使用这个网段。创建网段的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.20.0.0/24 mysql-ha-mmm-network</span><br><span class="line"></span><br><span class="line">我们使用下面的四条命令，启动 4 个 MySQL 数据库实例。这里我们把每一个数据库的 `my.cnf`  </span><br><span class="line">配置文件已经在本地配置好，然后通过数据卷的方式挂载到 MySQL 容器中，这样我们启动的 MySQL 数据库实例就会按照我们配置的 `my.cnf`  </span><br><span class="line">配置文件来启动并配置我们的 MySQL 数据库实例。</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 master1 节点 </span>  </span><br><span class="line">docker run --net=mysql-ha-mmm-network --hostname master1.mysql --ip 172.20.0.11 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-master1 -d -v Users/coder-home/docker\_mysql\_ha/mmm/master1:/etc/mysql/conf.d -e MYSQL\_ROOT_PASSWORD=root</span><br><span class="line">-e TZ=&quot;Asia/Shanghai&quot; -p 33011:3306 mysql:5.7.31</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 启动 slave1 节点 </span>  </span><br><span class="line">docker run --net=mysql-ha-mmm-network --hostname slave1.mysql --ip 172.20.0.12 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-slave1 -d -v Users/coder-home/docker\_mysql\_ha/mmm/slave1:/etc/mysql/conf.d -e MYSQL\_ROOT_PASSWORD=root</span><br><span class="line">-e TZ=&quot;Asia/Shanghai&quot; -p 33012:3306 mysql:5.7.31</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 启动 master2 节点 </span>  </span><br><span class="line">docker run --net=mysql-ha-mmm-network --hostname master2.mysql --ip 172.20.0.21 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-master2 -d -v Users/coder-home/docker\_mysql\_ha/mmm/master2:/etc/mysql/conf.d -e MYSQL\_ROOT_PASSWORD=root</span><br><span class="line">-e TZ=&quot;Asia/Shanghai&quot; -p 33021:3306 mysql:5.7.31</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 启动 slave2 节点</span>  </span><br><span class="line">docker run --net=mysql-ha-mmm-network --hostname slave2.mysql --ip 172.20.0.22 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-slave2 -d -v Users/coder-home/docker\_mysql\_ha/mmm/slave2:/etc/mysql/conf.d -e MYSQL\_ROOT_PASSWORD=root</span><br><span class="line">-e TZ=&quot;Asia/Shanghai&quot; -p 33022:3306 mysql:5.7.31</span><br></pre></td></tr></table></figure>

<p>这里解释一下 <code>docker run</code><br> 后面几个重要的参数和含义。</p>
<ul>
<li><p>–net&#x3D;mysql-ha-mmm-network：指定容器运行的时候使用的网段。</p>
</li>
<li><p>–hostname slave2.mysql：指定容器的主机名称。</p>
</li>
<li><p>–ip 172.20.0.22：指定容器使用的 IP 地址。</p>
</li>
<li><p>–cap-add NET_ADMIN：默认容器运行的时候，没有增加额外的 Linux 的功能，这里我们要增加上 NET_ADMIN 的功能，否则我们不能再启动后的容器内使用 ifconfig 命令增加虚拟 IP。否则会有如下错误提示：</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@test:/etc/network# ifconfig eth0:0 192.168.1.100 up  </span><br><span class="line">SIOCSIFADDR: Operation not permitted  </span><br><span class="line">SIOCSIFFLAGS: Operation not permitted  </span><br><span class="line">SIOCSIFFLAGS: Operation not permitted  </span><br><span class="line">root@test:/etc/network#</span><br></pre></td></tr></table></figure>

<ul>
<li><p>–name mysql-ha-mmm-slave2：指定容器的名称为<code>mysql-ha-mmm-slave2</code><br>，后面我们在停止或重启容器的时候，可以通过这个名称来操作容器。</p>
</li>
<li><p>-d：以 demon 进程的方式运行容器。</p>
</li>
<li><p>-v Users&#x2F;coder-home&#x2F;docker_mysql_ha&#x2F;mmm&#x2F;slave2:<br>&#x2F;etc&#x2F;mysql&#x2F;conf.d：把本地的 <code>/Users/coder-home/docker_mysql_ha/mmm/slave2</code><br> 目录挂载到容器中的 <code>/etc/mysql/conf.d</code><br> 目录下。</p>
</li>
<li><p>-e MYSQL_ROOT_PASSWORD&#x3D;root：向容器内传入参数，我们指定 MySQL 数据库 root 用户的密码也为 root。</p>
</li>
<li><p>-e TZ&#x3D;”Asia&#x2F;Shanghai”：向容器内传入参数，这里我们指定的容器中使用的系统的时区为上海时间。</p>
</li>
<li><p>-p 33022:3306：我们指定容器中的 3306 端口，映射到我们本地为 33022。这样我们在本地访问 MySQL 服务的时候，就可以通过 33022 端口来访问。</p>
</li>
<li><p>mysql:5.7.31：这个是我们要运行的容器的名称和版本。如果本地没有这个容器名称和版本，则会从 docker<br>hub 中自动拉取这个镜像名称和版本到本地，然后再启动这个镜像。</p>
</li>
</ul>
<p>容器启动后，我们可以查看启动后的结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker ps  </span><br><span class="line">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES  </span><br><span class="line">5207089da9a5 mysql:5.7.31        &quot;docker-entrypoint.s…&quot;   About a minute ago Up About a minute 33060/tcp, 0.0.0.0:</span><br><span class="line"><span class="meta prompt_">33022-&gt;</span><span class="language-bash">3306/tcp mysql-ha-mmm-slave2</span>  </span><br><span class="line">1c8ff5960272 mysql:5.7.31        &quot;docker-entrypoint.s…&quot;   About a minute ago Up About a minute 33060/tcp, 0.0.0.0:</span><br><span class="line"><span class="meta prompt_">33021-&gt;</span><span class="language-bash">3306/tcp mysql-ha-mmm-master2</span>  </span><br><span class="line">d8d646ba25f1 mysql:5.7.31        &quot;docker-entrypoint.s…&quot;   About a minute ago Up About a minute 33060/tcp, 0.0.0.0:</span><br><span class="line"><span class="meta prompt_">33012-&gt;</span><span class="language-bash">3306/tcp mysql-ha-mmm-slave1</span>  </span><br><span class="line">d3d75d9cd930 mysql:5.7.31        &quot;docker-entrypoint.s…&quot;   About a minute ago Up About a minute 33060/tcp, 0.0.0.0:</span><br><span class="line"><span class="meta prompt_">33011-&gt;</span><span class="language-bash">3306/tcp mysql-ha-mmm-master1</span>  </span><br><span class="line">➜  ~</span><br></pre></td></tr></table></figure>

<p>下面我们查看每一个 MySQL 数据库容器的 host 文件中的 IP 地址：</p>
<ul>
<li>master1 的 host 文件如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜ ~ docker exec -it mysql-ha-mmm-master1 bin/bash  </span><br><span class="line">root@master1:/# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.11 master1.mysql master1  </span><br><span class="line">root@master1:/#</span><br></pre></td></tr></table></figure>

<ul>
<li>master2 的 host 文件如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker exec -it mysql-ha-mmm-master2 bin/bash  </span><br><span class="line">root@master2:/# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.21 master2.mysql master2  </span><br><span class="line">root@master2:/#</span><br></pre></td></tr></table></figure>

<ul>
<li>slave1 的 host 文件如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker exec -it mysql-ha-mmm-slave1 bin/bash  </span><br><span class="line">root@slave1:/# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.12 slave1.mysql slave1  </span><br><span class="line">root@slave1:/#</span><br></pre></td></tr></table></figure>

<ul>
<li>slave2 的 host 文件如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker exec -it mysql-ha-mmm-slave2 bin/bash  </span><br><span class="line">root@slave2:/# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.22 slave2.mysql slave2  </span><br><span class="line">root@slave2:/#</span><br></pre></td></tr></table></figure>

<p>上面我们启动的四个 MySQL 数据库实例，我们还需要一个监控节点，下面启动一个监控节点，用于安装 MMM 的监控服务。</p>
<p>为了和其他环境一致，这里我们也使用上面 MySQL 的镜像。如下是启动一个新的 MySQL 容器，这个容器，我们不在挂载 MySQL 的 my.cnf 配置文件了，因为这个 MySQL 数据库我们不会使用，我们只是在这个容器中安装 MMM 的监控服务，我们此时把这个 MySQL 数据库容器当成一个 Debian 版本的虚拟机来使用。</p>
<h1 id="启动监控节点"><a href="# 启动监控节点" class="headerlink" title="启动监控节点"></a>启动监控节点</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --net=mysql-ha-mmm-network --hostname monitor.mysql --ip 172.20.0.10 --cap-add NET\_ADMIN --name</span><br><span class="line">mysql-ha-mmm-monitor -d -e MYSQL\_ROOT_PASSWORD=root -e TZ=&quot;Asia/Shanghai&quot; -p 33010:3306 mysql:5.7.31</span><br></pre></td></tr></table></figure>

<p>查看这个监控节点的 host 文件如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker exec -it mysql-ha-mmm-monitor bin/bash  </span><br><span class="line">root@monitor:~# cat etc/hosts  </span><br><span class="line">127.0.0.1 localhost  </span><br><span class="line">::1 localhost ip6-localhost ip6-loopback  </span><br><span class="line">fe00::0 ip6-localnet  </span><br><span class="line">ff00::0 ip6-mcastprefix  </span><br><span class="line">ff02::1 ip6-allnodes  </span><br><span class="line">ff02::2 ip6-allrouters  </span><br><span class="line">172.20.0.10 monitor.mysql monitor  </span><br><span class="line">root@monitor:~#</span><br></pre></td></tr></table></figure>

<h4 id="创建主从同步的数据库用户"><a href="# 创建主从同步的数据库用户" class="headerlink" title="创建主从同步的数据库用户"></a>创建主从同步的数据库用户 </h4><p> 在组从同步的时候，从需要使用一个指定的用户去连接到主上面同步主上面的 binlog 日志。所以，我们需要在我们的主上面创建好这样的一个用户。因为在 master1 宕机之后，MMM 组件会将 master2 提升为新的主库，所以需要在 master1 和 master2 上面都创建一个这样的用户，也就是下的命令需要在两个 master 节点上都执行一下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create user &#x27;repl_user&#x27;@&#x27;172.20.0.%&#x27; identified by &#x27;repl_user&#x27;;  </span><br><span class="line">grant replication slave on *.* to &#x27;repl_user&#x27;@&#x27;172.20.0.%&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="历史数据的同步"><a href="# 历史数据的同步" class="headerlink" title="历史数据的同步"></a>历史数据的同步 </h4><p> 如果我们并不是基于一个新的集群环境来搭建，而是基于一个已经运行了一段时间的 MySQL 数据库来做集群，此时我们需要把选定的 master 节点上面的数据，先使用 <code>mysqldump</code><br> 命令导出为 <code>.sql</code><br> 文件，然后再把这个 <code>.sql</code><br> 文件导入到所有的 slave 节点上去。然后在可以开始下面的任务。</p>
<p>在 master 上面执行的导出的命令示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -proot \  </span><br><span class="line">--master-data=2 \  </span><br><span class="line">--single-transaction \  </span><br><span class="line">--flush-logs \  </span><br><span class="line">--triggers \  </span><br><span class="line">--routines \  </span><br><span class="line">--events \  </span><br><span class="line">-B mydb1 &gt; mydb1.sql</span><br></pre></td></tr></table></figure>

<p>在所有的 slave 节点上执行的导入数据的命令示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -proot &lt; mydb1.sql</span><br></pre></td></tr></table></figure>

<p>但是，我们是基于一个崭新的环境来做的，不涉及到历史数据的问题。所以，这一步我们可以省略。</p>
<h4 id="开启组从同步"><a href="# 开启组从同步" class="headerlink" title="开启组从同步"></a>开启组从同步 </h4><p> 在所有的 slave 上面执行如下命令，此时的 binlog 文件和日志点的位置，可以在 master1 上面使用 <code>show master status</code><br> 命令查看，或者查看导出数据的时候，生成的 <code>.sql</code><br> 文件。在 master1 节点上执行 <code>mysqldump</code><br> 导出命令的时候，我们指定的 <code>--master-data=2</code><br>，这个参数会在导出的<code>.sql</code><br> 文件中标记当前 master1 节点上 binlog 日志的文件名称和日志偏移量。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=&#x27;172.20.0.11&#x27;, master_user=&#x27;repl_user&#x27;, master_password=&#x27;repl_user&#x27;,</span><br><span class="line">MASTER\_LOG\_FILE=&#x27;mysql-bin.000003&#x27;, MASTER\_LOG\_POS=1034;</span><br></pre></td></tr></table></figure>

<p>开启组从同步：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<p>查看同步状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show slave status\\G</span>  </span><br><span class="line">*************************** 1. row ***************************  </span><br><span class="line">Slave\_IO\_State: Waiting for master to send event  </span><br><span class="line">Master_Host: 172.20.0.11  </span><br><span class="line">Master\_User: repl\_user  </span><br><span class="line">Master_Port: 3306  </span><br><span class="line">Connect_Retry: 60  </span><br><span class="line">Master\_Log\_File: mysql-bin.000003  </span><br><span class="line">Read\_Master\_Log_Pos: 1034  </span><br><span class="line">Relay\_Log\_File: mysql-relay.000002  </span><br><span class="line">Relay\_Log\_Pos: 320  </span><br><span class="line">Relay\_Master\_Log_File: mysql-bin.000003  </span><br><span class="line">Slave\_IO\_Running: Yes  </span><br><span class="line">Slave\_SQL\_Running: Yes  </span><br><span class="line">Replicate\_Do\_DB:  </span><br><span class="line">Replicate\_Ignore\_DB:  </span><br><span class="line">Replicate\_Do\_Table:  </span><br><span class="line">Replicate\_Ignore\_Table:  </span><br><span class="line">Replicate\_Wild\_Do_Table:  </span><br><span class="line">Replicate\_Wild\_Ignore_Table:  </span><br><span class="line">Last_Errno: 0  </span><br><span class="line">Last_Error:  </span><br><span class="line">Skip_Counter: 0  </span><br><span class="line">Exec\_Master\_Log_Pos: 1034  </span><br><span class="line">Relay\_Log\_Space: 523  </span><br><span class="line">Until_Condition: None  </span><br><span class="line">Until\_Log\_File:  </span><br><span class="line">Until\_Log\_Pos: 0  </span><br><span class="line">Master\_SSL\_Allowed: No  </span><br><span class="line">Master\_SSL\_CA_File:  </span><br><span class="line">Master\_SSL\_CA_Path:  </span><br><span class="line">Master\_SSL\_Cert:  </span><br><span class="line">Master\_SSL\_Cipher:  </span><br><span class="line">Master\_SSL\_Key:  </span><br><span class="line">Seconds\_Behind\_Master: 0  </span><br><span class="line">Master\_SSL\_Verify\_Server\_Cert: No  </span><br><span class="line">Last\_IO\_Errno: 0  </span><br><span class="line">Last\_IO\_Error:  </span><br><span class="line">Last\_SQL\_Errno: 0  </span><br><span class="line">Last\_SQL\_Error:  </span><br><span class="line">Replicate\_Ignore\_Server_Ids:  </span><br><span class="line">Master\_Server\_Id: 11  </span><br><span class="line">Master_UUID: 047bcc07-7424-11eb-96b4-0242ac14000b  </span><br><span class="line">Master\_Info\_File: mysql.slave\_master\_info  </span><br><span class="line">SQL_Delay: 0  </span><br><span class="line">SQL\_Remaining\_Delay: NULL  </span><br><span class="line">Slave\_SQL\_Running_State: Slave has read all relay log; waiting for more updates  </span><br><span class="line">Master\_Retry\_Count: 86400  </span><br><span class="line">Master_Bind:  </span><br><span class="line">Last\_IO\_Error_Timestamp:  </span><br><span class="line">Last\_SQL\_Error_Timestamp:  </span><br><span class="line">Master\_SSL\_Crl:  </span><br><span class="line">Master\_SSL\_Crlpath:  </span><br><span class="line">Retrieved\_Gtid\_Set:  </span><br><span class="line">Executed\_Gtid\_Set:  </span><br><span class="line">Auto_Position: 0  </span><br><span class="line">Replicate\_Rewrite\_DB:  </span><br><span class="line">Channel_Name:  </span><br><span class="line">Master\_TLS\_Version:  </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置主与主的同步"><a href="# 配置主与主的同步" class="headerlink" title="配置主与主的同步"></a>配置主与主的同步 </h4><p> 上面我们配置好了 <code>master1-&gt;slave1，master1-&gt;slave2</code><br> 的同步。我们还需要在 master1 和 master2 直接配置互相同步对方。</p>
<p>现在 master2 上面配置 master1 作为它的主库。参考上面 slave1 和 slave2 上面的配置。执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=&#x27;172.20.0.11&#x27;, MASTER\_LOG\_FILE=&#x27;mysql-bin.000003&#x27;, MASTER\_LOG\_POS=1034;</span><br><span class="line"></span><br><span class="line">start slave user=&#x27;repl_user&#x27; password=&#x27;repl_user&#x27;;</span><br><span class="line"></span><br><span class="line">show slave status\\G</span><br></pre></td></tr></table></figure>

<p>然后再配置 master2 到 master1 的同步。此时我们需要查看一下 master2 上面的 binlog 日志名称和日志偏移量是多少。使用如下命令查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show master status\\G</span>  </span><br><span class="line">*************************** 1. row ***************************  </span><br><span class="line">File: mysql-bin.000003  </span><br><span class="line">Position: 623  </span><br><span class="line">Binlog\_Do\_DB:  </span><br><span class="line">Binlog\_Ignore\_DB:  </span><br><span class="line">Executed\_Gtid\_Set:  </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_">mysql&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后我们登录到 master1 上面，执行如下命令，配置 master2 作为 master1 的主库。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=&#x27;172.20.0.21&#x27;, MASTER\_LOG\_FILE=&#x27;mysql-bin.000003&#x27;, MASTER\_LOG\_POS=623;</span><br><span class="line"></span><br><span class="line">start slave user=&#x27;repl_user&#x27; password=&#x27;repl_user&#x27;;</span><br><span class="line"></span><br><span class="line">show slave status\\G</span><br></pre></td></tr></table></figure>

<p>验证双主双从同步的效果如下：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62218319710000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62218319710000.png"></a></p>
<h3 id="安装 MMM"><a href="# 安装 MMM" class="headerlink" title="安装 MMM"></a>安装 MMM</h3><h4 id="修改 apt-get 源"><a href="# 修改 apt-get 源" class="headerlink" title="修改 apt-get 源"></a>修改 apt-get 源 </h4><p> 在下载 MMM 之前，我们先修改一下 <code>apt-get</code><br> 源，然后更新一下 <code>apt-get</code><br> 源。如下所示，因为此时的容器中，没有 <code>vim</code><br> 命令，所以我们使用 <code>echo &quot;xxx&quot; &gt;/etc/apt/sources.list</code><br> 的方式去更新 <code>apt-get</code><br> 的源。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;  </span><br><span class="line">deb http://mirrors.aliyun.com/debian/ buster main non-free contrib  </span><br><span class="line">deb http://mirrors.aliyun.com/debian-security buster/updates main  </span><br><span class="line">deb http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib  </span><br><span class="line">deb http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib</span><br><span class="line"></span><br><span class="line">deb-src http://mirrors.aliyun.com/debian-security buster/updates main  </span><br><span class="line">deb-src http://mirrors.aliyun.com/debian/ buster main non-free contrib  </span><br><span class="line">deb-src http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib  </span><br><span class="line">deb-src http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib  </span><br><span class="line">&quot; &gt; etc/apt/sources.list</span><br></pre></td></tr></table></figure>

<p>注意，在更新镜像源的时候，要根据自己的 Debian 系统的版本，我的 Debian 系统的版本是 <code>buster</code><br> 版本，所以你要根据自己的系统版本网上找到对应的镜像地址。接着，我们更新一下系统。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/apt# apt-get update  </span><br><span class="line">Get:1 http://security.debian.org/debian-security buster/updates InRelease \[65.4 kB\]  </span><br><span class="line">Get:2 http://repo.mysql.com/apt/debian buster InRelease \[21.5 kB\]  </span><br><span class="line">Get:3 http://mirrors.ustc.edu.cn/debian buster InRelease \[122 kB\]  </span><br><span class="line">Get:4 http://security.debian.org/debian-security buster/updates/main amd64 Packages \[267 kB\]  </span><br><span class="line">Get:5 http://mirrors.ustc.edu.cn/debian buster-updates InRelease \[51.9 kB\]  </span><br><span class="line">Get:6 http://mirrors.ustc.edu.cn/debian buster/main amd64 Packages \[7907 kB\]  </span><br><span class="line">Get:7 http://repo.mysql.com/apt/debian buster/mysql-5.7 amd64 Packages \[5693 B\]  </span><br><span class="line">Get:8 http://mirrors.ustc.edu.cn/debian buster-updates/main amd64 Packages \[9504 B\]  </span><br><span class="line">Fetched 8450 kB in 10s (871 kB/s)  </span><br><span class="line">Reading package lists... Done  </span><br><span class="line">root@master1:/etc/apt#</span><br></pre></td></tr></table></figure>

<p>更新完成之后，我们先安装一下我们经常用到的几个命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install net-tools wget vim make cmake inetutils-ping iproute2 iproute2-doc -y</span><br></pre></td></tr></table></figure>

<h4 id="下载 MMM"><a href="# 下载 MMM" class="headerlink" title="下载 MMM"></a>下载 MMM</h4><p>推荐使用源码来安装，这样可以在任何 Linux 系统版本上面进行安装，例如：Ubuntu、Debian、CentOS、Redhat 等等。不用因为系统版本的问题找对应的 <code>rpm</code><br> 包，找对应的 <code>deb</code><br> 包。</p>
<p>通过如下步骤来获取 MMM 的源码。</p>
<p>登录 Debian 的官方网站：<a href="https://www.debin.org, 然后点击跟多关于下载与软件介绍的连接./" rel="external nofollow noreferrer">https://www.debin.org，然后点击跟多关于下载与软件介绍的连接。</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62227796992000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62227796992000.png"></a></p>
<p>此时我们会进入如下页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.debian.org/intro/index#software%EF%BC%8C%E7%84%B6%E5%90%8E%E7%82%B9%E5%87%BB%E8%BD%AF%E4%BB%B6%E5%8C%85%E8%BF%9E%E6%8E%A5%E3%80%82">https://www.debian.org/intro/index#software，然后点击软件包连接。</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62232996113000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62232996113000.png"></a></p>
<p>接着，我们会进入如下页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.debian.org/distrib/packages#search_packages%EF%BC%8C%E6%A0%B9%E6%8D%AE%E9%80%89%E9%A1%B9%E8%BE%93%E5%85%A5%60mysql-mmm%60">https://www.debian.org/distrib/packages#search_packages，根据选项输入 `mysql-mmm`</a><br>，点击搜索按钮。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62238380248100.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62238380248100.png"></a></p>
<p>点击上面的搜索按钮后，进入如下页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://packages.debian.org/search?keywords=mysql-mmm&searchon=names&suite=oldstable&section=all%EF%BC%8C%E7%84%B6%E5%90%8E%E6%88%91%E4%BB%AC%E7%82%B9%E5%87%BB%E9%A1%B5%E9%9D%A2%E4%B8%AD%E7%9A%84Debian%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%89%88%E6%9C%AC%EF%BC%8C%E9%80%89%E6%8B%A9%60jessie%60">https://packages.debian.org/search?keywords=mysql-mmm&amp;searchon=names&amp;suite=oldstable&amp;section=all，然后我们点击页面中的 Debian 系统的版本，选择 `jessie`</a><br>版本，因为 <code>mysql-mmm</code><br> 是比较老的一种 MySQL 考可用架构，在最新的 Debian 系统中，已经没有这样的软件包了，所以我们选择老版本的 <code>jessie</code><br> 版本，这个版本中包含 <code>mysql-mmm</code><br> 的源码。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62244923390700.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62244923390700.png"></a></p>
<p>点击完成 <code>jessie</code><br> 之后，进入如下页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://packages.debian.org/search?suite=jessie&searchon=names&keywords=mysql-mmm%EF%BC%8C%E6%AD%A4%E6%97%B6%E6%88%91%E4%BB%AC%E5%B7%B2%E7%BB%8F%E6%90%9C%E7%B4%A2%E5%88%B0%E4%BA%86%60mysql-mmm%60">https://packages.debian.org/search?suite=jessie&amp;searchon=names&amp;keywords=mysql-mmm，此时我们已经搜索到了 `mysql-mmm`</a><br>的软件。点击其中任何一个链接，进入详细页面。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62249976051000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62249976051000.png"></a></p>
<p>进入如下的页面：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://packages.debian.org/jessie/mysql-mmm-tools%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%89%E6%8B%A9%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E6%96%87%E4%BB%B6%E3%80%82">https://packages.debian.org/jessie/mysql-mmm-tools，我们选择下载源码文件。</a></p>
<p>或者我们可以右键复制下载地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://deb.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm_2.2.1.orig.tar.gz%EF%BC%8C%E4%BD%BF%E7%94%A8wget%E5%91%BD%E4%BB%A4%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E5%88%B0MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E3%80%82">http://deb.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm_2.2.1.orig.tar.gz，使用 wget 命令下载源码到 MySQL 服务器上。</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://deb.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm_2.2.1.orig.tar.gz</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62257452614500.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62257452614500.png"></a></p>
<p>如果要下载.deb 文件，可以点击上面图片中的硬件架构下面的 <code>all</code><br> 连接，进入下面页面后，选择对应的距离我们最近镜像地址，我选择的为 <code>ftp.cn.debian.org</code><br> 这个镜像地址，然后复制下载链接地址，使用 wget 下载即可。这里贴出如下的下载示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.cn.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm-tools\_2.2.1-1.1\_all.deb  </span><br><span class="line">wget http://ftp.cn.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm-monitor\_2.2.1-1.1\_all.deb  </span><br><span class="line">wget http://ftp.cn.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm-common\_2.2.1-1.1\_all.deb  </span><br><span class="line">wget http://ftp.cn.debian.org/debian/pool/main/m/mysql-mmm/mysql-mmm-agent\_2.2.1-1.1\_all.deb</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62278934447800.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62278934447800.png"></a></p>
<h4 id="编译安装 MMM"><a href="# 编译安装 MMM" class="headerlink" title="编译安装 MMM"></a>编译安装 MMM</h4><p>我们是使用的 MySQL 的容器镜像来启动的 MySQL 集群，而这个从 docker<br>hub 上面拉取的 MySQL5.7 官方版本的镜像是基于 Debian 系统来制作的，所以我们此次安装 MMM 软件需要基于 Debian 系统来安装。</p>
<p>下载好的 <code>mysql-mmm</code><br> 如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# ls -lstr  </span><br><span class="line">total 60  </span><br><span class="line">56 -rw-r--r-- 1 root root 55278 Feb 21 16:22 mysql-mmm_2.2.1.orig.tar.gz  </span><br><span class="line">4 drwxr-xr-x 2 root root 4096 Feb 21 16:24 deb  </span><br><span class="line">root@test:~#</span><br></pre></td></tr></table></figure>

<p>解压并且安装，但是在安装 MMM 之前，先安装一下它的依赖包，使用如下命令来安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install liblog-log4perl-perl libmailtools-perl liblog-dispatch-perl libclass-singleton-perl libproc-daemon-perl</span><br><span class="line">libalgorithm-diff-perl libdbi-perl libdbd-mysql-perl -y</span><br></pre></td></tr></table></figure>

<p>安装 MMM 的命令和过程如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@test:~# tar -zxf mysql-mmm_2.2.1.orig.tar.gz  </span><br><span class="line">root@test:~# ls -lstr  </span><br><span class="line">total 64  </span><br><span class="line">4 drwxr-xr-x 6 root root 4096 May 7 2010 mysql-mmm-2.2.1  </span><br><span class="line">56 -rw-r--r-- 1 root root 55278 Feb 21 16:22 mysql-mmm_2.2.1.orig.tar.gz  </span><br><span class="line">4 drwxr-xr-x 2 root root 4096 Feb 21 16:24 deb  </span><br><span class="line">root@test:~# cd mysql-mmm-2.2.1/  </span><br><span class="line">root@test:~/mysql-mmm-2.2.1# make install  </span><br><span class="line">mkdir -p usr/share/perl5/MMM usr/lib/mysql-mmm usr/sbin var/log/mysql-mmm etc etc/mysql-mmm etc/init.d/  </span><br><span class="line">cp -r lib/Common/ usr/share/perl5/MMM  </span><br><span class="line">\[-f etc/mysql-mmm/mmm_common.conf \] || cp etc/mysql-mmm/mmm_common.conf etc/mysql-mmm/  </span><br><span class="line">mkdir -p usr/lib/mysql-mmm/agent/  </span><br><span class="line">cp -r lib/Agent/ usr/share/perl5/MMM  </span><br><span class="line">cp -r bin/agent/* usr/lib/mysql-mmm/agent/  </span><br><span class="line">cp -r etc/init.d/mysql-mmm-agent etc/init.d/  </span><br><span class="line">cp sbin/mmm_agentd usr/sbin  </span><br><span class="line">\[-f etc/mysql-mmm/mmm_agent.conf \] || cp etc/mysql-mmm/mmm_agent.conf etc/mysql-mmm/  </span><br><span class="line">mkdir -p usr/lib/mysql-mmm/monitor/  </span><br><span class="line">cp -r lib/Monitor/ usr/share/perl5/MMM  </span><br><span class="line">cp -r bin/monitor/* usr/lib/mysql-mmm/monitor/  </span><br><span class="line">cp -r etc/init.d/mysql-mmm-monitor etc/init.d/  </span><br><span class="line">cp sbin/mmm\_control sbin/mmm\_mond usr/sbin  </span><br><span class="line">\[-f etc/mysql-mmm/mmm_mon.conf \] || cp etc/mysql-mmm/mmm_mon.conf etc/mysql-mmm/  </span><br><span class="line">mkdir -p usr/lib/mysql-mmm/tools/  </span><br><span class="line">cp -r lib/Tools/ usr/share/perl5/MMM  </span><br><span class="line">cp -r bin/tools/* usr/lib/mysql-mmm/tools/  </span><br><span class="line">cp sbin/mmm\_backup sbin/mmm\_clone sbin/mmm_restore usr/sbin  </span><br><span class="line">\[-f etc/mysql-mmm/mmm_tools.conf \] || cp etc/mysql-mmm/mmm_tools.conf etc/mysql-mmm/  </span><br><span class="line">root@test:~/mysql-mmm-2.2.1#</span><br></pre></td></tr></table></figure>

<p>如果在安装 <code>mmm</code><br> 的时候，提示没有 <code>make</code><br> 命令，则需要先安装 <code>make</code><br> 命令，安装的时候如果是 Debian 或 Ubuntu 系统，使用如下 apt-get 命令安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install make cmake -y</span><br></pre></td></tr></table></figure>

<p>如果是 CentOS 或 Redhat 系统，则使用如下的 yum 命令来安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install make cmake -y</span><br></pre></td></tr></table></figure>

<p>以上编译安装 MMM 需要在每一个节点都执行，包括两个 master 节点和两个 slave 节点，还有 monitor 监控节点也要安装。</p>
<p>安装完 MMM 之后，我们需要注意一下几个目录，这是我们使用 MMM 服务的基础。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MMM 各种配置文件所在目录 </span>  </span><br><span class="line">/etc/mysql-mmm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MMM 服务日志文件所在目录</span>  </span><br><span class="line">/var/log/mysql-mmm/mmm_mond.log # MMM 的 monitor 服务的日志文件  </span><br><span class="line">/var/log/mysql-mmm/mmm_agentd.log # MMM 的 agent 服务的日志文件</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 各种 perl 脚本所在目录 </span>  </span><br><span class="line">/usr/lib/mysql-mmm/agent # agent 客户端各种脚本所在目录  </span><br><span class="line">/usr/lib/mysql-mmm/monitor # monitor 监控端各种脚本所在目录  </span><br><span class="line">/usr/lib/mysql-mmm/tools # 工具包脚本所在目录</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 启动和关闭 MMM 服务的脚本文件</span>  </span><br><span class="line">/etc/init.d/mysql-mmm-agent  </span><br><span class="line">/etc/init.d/mysql-mmm-monitor</span><br></pre></td></tr></table></figure>

<h3 id="创建 MMM 使用的 MySQL 用户"><a href="# 创建 MMM 使用的 MySQL 用户" class="headerlink" title="创建 MMM 使用的 MySQL 用户"></a>创建 MMM 使用的 MySQL 用户 </h3><p> 监控用和客户端用户，在所有的节点上都要创建这两个用户。如果已经配置组从同步，在 master1 上创建就 OK，其他节点会自动同步这两个创建好的用户到其他节点。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create user &#x27;mmm_monitor&#x27;@&#x27;172.20.0.%&#x27; identified by &#x27;mmm_monitor&#x27;;  </span><br><span class="line">grant replication client on *.* to &#x27;mmm_monitor&#x27;@&#x27;172.20.0.%&#x27;;</span><br><span class="line"></span><br><span class="line">create user &#x27;mmm_agent&#x27;@&#x27;172.20.0.%&#x27; identified by &#x27;mmm_agent&#x27;;  </span><br><span class="line">grant super, replication client, process on *.* to &#x27;mmm_agent&#x27;@&#x27;172.20.0.%&#x27;;</span><br></pre></td></tr></table></figure>

<p>需要注意的是这两个用户的权限不同，结合前面我们配置组从同步的哪一个用户，我们来对比一下：</p>
<ul>
<li><p>monitor：MMM 监控使用的用户，拥有 replication client 权限就可以。</p>
</li>
<li><p>agent：MMM 客户单使用的用，拥有 super、replication client、process 权限。</p>
</li>
<li><p>replication：组从同步使用的用户，拥有 replication slave 权限即可。</p>
</li>
</ul>
<p>最后的用户在四个节点上面的结果如下图所示：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62291961300000.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62291961300000.png"></a></p>
<h3 id="修改 MMM 的配置文件"><a href="# 修改 MMM 的配置文件" class="headerlink" title="修改 MMM 的配置文件"></a>修改 MMM 的配置文件</h3><p>MMM 所有的配置文件都在如下目录中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/mysql-mmm# ls -lstr etc/mysql-mmm/*  </span><br><span class="line">4 -rw-r</span><br><span class="line">----- 1 root root 321 Feb 22 21:46 etc/mysql-mmm/mmm_mon.conf  </span><br><span class="line">4 -rw-r</span><br><span class="line">----- 1 root root 1293 Feb 22 21:46 etc/mysql-mmm/mmm_tools.conf  </span><br><span class="line">4 -rw-r</span><br><span class="line">----- 1 root root 37 Feb 22 22:21 etc/mysql-mmm/mmm_agent.conf  </span><br><span class="line">4 -rw-r</span><br><span class="line">----- 1 root root 789 Feb 22 23:20 etc/mysql-mmm/mmm_common.conf  </span><br><span class="line">root@master1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p><strong>mmm_comm.conf 配置文件</strong></p>
<p>所有 5 个节点中的 <code>/etc/mysql-mmm/mmm_common.conf</code><br> 配置文件都修改为如下所示的内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/mysql-mmm# cat mmm_common.conf</span><br><span class="line"></span><br><span class="line">active\_master\_role writer</span><br><span class="line">&lt;host default&gt;  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网卡的名称，各个主机上面网络设备的名称 </span>  </span><br><span class="line">	cluster_interface		eth0</span><br><span class="line"></span><br><span class="line">	pid\_path			/var/run/mmm\_agentd.pid  </span><br><span class="line">	bin_path			/usr/lib/mysql-mmm/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 主从复制用户名和密码 </span>  </span><br><span class="line">replication\_user repl\_user  </span><br><span class="line">replication\_password repl\_user</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MMM 服务使用的 anget 用户名和密码</span>  </span><br><span class="line">agent\_user mmm\_agent  </span><br><span class="line">agent\_password mmm\_agent</span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master1 的配置信息</span>  </span><br><span class="line">&lt;host master1&gt;  </span><br><span class="line">ip 172.20.0.11  </span><br><span class="line">mode master  </span><br><span class="line">peer master2  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master2 的配置信息</span>  </span><br><span class="line">&lt;host master2&gt;  </span><br><span class="line">ip 172.20.0.21  </span><br><span class="line">mode master  </span><br><span class="line">peer master1  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slave1 的配置信息</span>  </span><br><span class="line">&lt;host slave1&gt;  </span><br><span class="line">ip 172.20.0.12  </span><br><span class="line">mode slave  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slave2 的配置信息</span>  </span><br><span class="line">&lt;host slave2&gt;  </span><br><span class="line">ip 172.20.0.22  </span><br><span class="line">mode slave  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 写虚拟 IP 的配置信息，指定可写的主机名称 </span>  </span><br><span class="line">&lt;role writer&gt;  </span><br><span class="line">hosts master1, master2  </span><br><span class="line">ips 172.20.0.100  </span><br><span class="line">mode exclusive  </span><br><span class="line">&lt;/role&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 读虚拟 IP 的配置信息，指定可以提供读服务的主机名称。下面的 VIP 和主键名称不一定是一一对应的，VIP 是随机分布到各个可读节点的。</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果提供多个 VIP，有可能一个节点被分配多个 VIP，这样也是支持的。</span>  </span><br><span class="line">&lt;role reader&gt;  </span><br><span class="line">hosts master1, master2, slave1, slave2  </span><br><span class="line">ips 172.20.0.111, 172.20.0.211, 172.20.0.122, 172.20.0.222  </span><br><span class="line">mode balanced  </span><br><span class="line">&lt;/role&gt;</span><br><span class="line">root@master1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>上面的 <code>role reader</code><br> 中配置的可读节点，可以根据自己的需求来配置，这里我把 <code>master1, master2, slave1, slave2</code><br> 都作为可读的节点，当然可以把主节点 <code>master1</code><br> 去掉，只配置 <code>master2, slave1, slave2</code><br> 三个节点。这里的 <code>ips</code><br> 也是我们指定的 VIP 的值，我们可以配置多个 VIP，最好是 VIP 的个数和上面的 host 的数目一致，表示每一个提供读的节点分配一个 VIP。</p>
<p><strong>mmm_agent.conf 配置文件</strong></p>
<p>每一个节点上面的 <code>/etc/mysql-mmm/mmm_agent.conf</code><br> 配置文件中，都在第 2 行中，修改一下主机名称。下面给出 master1 节点的配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/mysql-mmm# cat mmm_agent.conf  </span><br><span class="line">include mmm_common.conf  </span><br><span class="line">this master1  </span><br><span class="line">root@master1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>其他 master2、slave1、slave2 各个节点也需要作出对应的修改。只要把 master1 改为对应的主机名称即可。</p>
<p><strong>mmm_mon.conf 配置文件</strong></p>
<p>在 monitor 节点上，修改 <code>/etc/mysql-mmm/mmm_mon.conf</code><br> 配置文件，修改内容如下所示，其他四个节点不需要对这个文件做修改。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# cat mmm_mon.conf  </span><br><span class="line">include mmm_common.conf</span><br><span class="line"></span><br><span class="line">&lt;monitor&gt;  </span><br><span class="line">	ip					127.0.0.1  </span><br><span class="line">	pid\_path				/var/run/mmm\_mond.pid  </span><br><span class="line">	bin_path				/usr/lib/mysql-mmm/  </span><br><span class="line">	status\_path				/var/lib/misc/mmm\_mond.status  </span><br><span class="line">	ping_ips				172.20.0.1, 172.20.0.11, 172.20.0.21, 172.20.0.12, 172.20.0.22 # 网关 IP 地址，和各个节点的物理 IP 地址，用于监控各个节点的状态是否可用  </span><br><span class="line">&lt;/monitor&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MMM 服务使用 MySQL 中的 monitor 用户名称和密码</span>  </span><br><span class="line">&lt;host default&gt;  </span><br><span class="line">monitor\_user mmm\_monitor  </span><br><span class="line">monitor\_password mmm\_monitor  </span><br><span class="line">&lt;/host&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">debug 值为 0 非 debug 模式，为 1 的时候表示 debug 模式，debug 模式下，会在 /var/log/mysql-mmm/mmm_mond.log 日志文件中生成更多日志信息。</span>  </span><br><span class="line">debug 0  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<h3 id="启动 MMM 服务"><a href="# 启动 MMM 服务" class="headerlink" title="启动 MMM 服务"></a>启动 MMM 服务 </h3><p> 客户端 agent 服务相关命令如下，客户端 agent 启动后日志存放在 <code>/var/log/mysql-mmm/mmm_agentd.log</code><br> 文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql-mmm-agent start  </span><br><span class="line">/etc/init.d/mysql-mmm-agent status  </span><br><span class="line">/etc/init.d/mysql-mmm-agent stop  </span><br><span class="line">/etc/init.d/mysql-mmm-agent restart</span><br></pre></td></tr></table></figure>

<p>监控端 monitor 服务相关命令如下，监控端 monitor 启动后日志存放在 <code>/var/log/mysql-mmm/mmm_mond.log</code><br> 文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql-mmm-monitor start  </span><br><span class="line">/etc/init.d/mysql-mmm-monitor status  </span><br><span class="line">/etc/init.d/mysql-mmm-monitor stop  </span><br><span class="line">/etc/init.d/mysql-mmm-monitor restart</span><br></pre></td></tr></table></figure>

<p>MMM 监控状态有一个管理命令<code>mmm_control</code><br>，它的使用帮助如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/# mmm_control --help  </span><br><span class="line">Invalid command &#x27;--help&#x27;</span><br><span class="line"></span><br><span class="line">Valid commands are:  </span><br><span class="line">help \- show this message  </span><br><span class="line">ping \- ping monitor  </span><br><span class="line">show - show status  </span><br><span class="line">checks \[&lt;host&gt;|all \[&lt;check&gt;|all\]\] - show checks status  </span><br><span class="line">set_online &lt;host&gt;                 \- set host &lt;host&gt; online  </span><br><span class="line">set_offline &lt;host&gt;                \- set host &lt;host&gt; offline  </span><br><span class="line">mode - print current mode.  </span><br><span class="line">set_active - switch into active mode.  </span><br><span class="line">set_manual - switch into manual mode.  </span><br><span class="line">set_passive - switch into passive mode.  </span><br><span class="line">move_role \[--force\] &lt;role&gt; &lt;host&gt; \- move exclusive role &lt;role&gt; to host &lt;host&gt;  </span><br><span class="line">(Only use --force if you know what you are doing!)  </span><br><span class="line">set_ip &lt;ip&gt; &lt;host&gt;                \- set role with ip &lt;ip&gt; to host &lt;host&gt;</span><br><span class="line"></span><br><span class="line">root@monitor:/#</span><br></pre></td></tr></table></figure>

<p>常用的维护节点状态的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mmm_control show  </span><br><span class="line">mmm_control checks all  </span><br><span class="line">mmm\_control set\_online master1  </span><br><span class="line">mmm\_control set\_online master2  </span><br><span class="line">mmm\_control set\_online slave1  </span><br><span class="line">mmm\_control set\_online slave2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>下面分别在四个 MySQL 节点上执行如下命令启动并查看 MMM 的客户端服务</strong></p>
<ul>
<li>master1 主节点上，启动和查看 MMM 的客户端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Starting MMM Agent daemon... Ok</span><br><span class="line"></span><br><span class="line">root@master1:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Checking MMM Agent process: running.  </span><br><span class="line">root@master1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<ul>
<li>master2 主节点上，启动和查看 MMM 的客户端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@master2:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Starting MMM Agent daemon... Ok</span><br><span class="line"></span><br><span class="line">root@master2:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Checking MMM Agent process: running.  </span><br><span class="line">root@master2:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<ul>
<li>slave1 主节点上，启动和查看 MMM 的客户端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@slave1:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Starting MMM Agent daemon... Ok</span><br><span class="line"></span><br><span class="line">root@slave1:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Checking MMM Agent process: running.  </span><br><span class="line">root@slave1:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<ul>
<li>slave2 主节点上，启动 MMM 的客户端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@slave2:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Starting MMM Agent daemon... Ok</span><br><span class="line"></span><br><span class="line">root@slave2:/etc/mysql-mmm# etc/init.d/mysql-mmm-agent status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_agentd&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_agentd.pid&#x27;  </span><br><span class="line">Checking MMM Agent process: running.  </span><br><span class="line">root@slave2:/etc/mysql-mmm#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>下面在监控节点上执行如下命令启动并查看 MMM 的监控服务</strong></p>
<ul>
<li>monitor 节点上，启动和查看 MMM 的监控端服务如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# etc/init.d/mysql-mmm-monitor start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_mond&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_mond.pid&#x27;  </span><br><span class="line">Starting MMM Monitor daemon: Ok</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm# etc/init.d/mysql-mmm-monitor status  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_mond&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_mond.pid&#x27;  </span><br><span class="line">Checking MMM Monitor process: running.  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<ul>
<li>在 monitor 节点，查看监控的状态：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/AWAITING_RECOVERY. Roles:  </span><br><span class="line">master2(172.20.0.21) master/AWAITING_RECOVERY. Roles:  </span><br><span class="line">slave1(172.20.0.12) slave/AWAITING_RECOVERY. Roles:  </span><br><span class="line">slave2(172.20.0.22) slave/AWAITING_RECOVERY. Roles:</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online master1;  </span><br><span class="line">OK: State of &#x27;master1&#x27; changed to ONLINE. Now you can wait some time and check its new roles!  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online master2  </span><br><span class="line">OK: State of &#x27;master2&#x27; changed to ONLINE. Now you can wait some time and check its new roles!  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online slave1  </span><br><span class="line">OK: State of &#x27;slave1&#x27; changed to ONLINE. Now you can wait some time and check its new roles!  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online slave2  </span><br><span class="line">OK: State of &#x27;slave2&#x27; changed to ONLINE. Now you can wait some time and check its new roles!  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/ONLINE. Roles: reader(172.20.0.111), writer(172.20.0.100)  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.211)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.122)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p><strong>问题排查 1：monitor 服务不能正常启动？</strong></p>
<p>当在 monitor 节点启动监控服务后，监控服务一会就异常退出了。原因是在使用 docker 启动集群节点的时候没有使用 <code>--cap-add NET_ADMIN</code><br> 参数，没有这个参数就没有办法在容器只用使用虚拟 VIP 的功能。在删除容器后，增加参数重新运行后，才运行起来。</p>
<p>后来，又发现 monitor 节点启监控服务器仍然失败，查看日志<code>/var/log/mysql-mmm/mmm_mond.log</code><br>，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# tail -f var/log/mysql-mmm/mmm_mond.log  </span><br><span class="line">2021/02/22 23:26:27 INFO Waiting for network connection...  </span><br><span class="line">2021/02/22 23:26:27 INFO Spawning checker &#x27;ping_ip&#x27;...  </span><br><span class="line">2021/02/22 23:26:27 INFO Shutting down checker &#x27;ping_ip&#x27;...  </span><br><span class="line">2021/02/22 23:26:27 INFO Network connection is available.  </span><br><span class="line">2021/02/22 23:26:27 FATAL Child exited with exitcode 255, restarting after 10 second sleep</span><br></pre></td></tr></table></figure>

<p>修改 <code>/etc/mysql-mmm/mmm_mon.conf</code><br> 配置文件中的 <code>debug</code><br> 的值为 <code>1</code><br>，表示以<code>debug</code><br> 的模式运行 monitor 服务，此时我们再重新启动 monitor 服务，查看输出的详细错误日志如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# etc/init.d/mysql-mmm-monitor start  </span><br><span class="line">Daemon bin: &#x27;/usr/sbin/mmm_mond&#x27;  </span><br><span class="line">Daemon pid: &#x27;/var/run/mmm_mond.pid&#x27;  </span><br><span class="line">Starting MMM Monitor daemon: 2021/02/22 23:30:17 INFO STARTING...  </span><br><span class="line">2021/02/22 23:30:17 DEBUG Created pid file &#x27;/var/run/mmm_mond.pid&#x27; with pid 5330  </span><br><span class="line">2021/02/22 23:30:17 INFO Waiting for network connection...  </span><br><span class="line">2021/02/22 23:30:17 INFO Spawning checker &#x27;ping_ip&#x27;...  </span><br><span class="line">2021/02/22 23:30:17 DEBUG IP &#x27;172.20.0.1&#x27; is reachable: OK  </span><br><span class="line">2021/02/22 23:30:17 INFO Shutting down checker &#x27;ping_ip&#x27;...  </span><br><span class="line">2021/02/22 23:30:17 INFO Network connection is available.  </span><br><span class="line">Use of uninitialized value $old_state in string ne at usr/share/perl5/MMM/Monitor/Agent.pm line 42.  </span><br><span class="line">2021/02/22 23:30:17 FATAL Child exited with exitcode 255, restarting after 10 second sleep</span><br></pre></td></tr></table></figure>

<p>于是去修改了 <code>/usr/share/perl5/MMM/Monitor/Agent.pm</code><br> 文件，在第 41 行增加如下内容，保存退出，重新启动 monitor 服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (! defined($old\_state)) &#123; $old\_state = &#x27;certinally not new_state&#x27;; &#125;</span><br></pre></td></tr></table></figure>

<p>然后再次重启 monitor 服务，启动成功。然后把 <code>/etc/mysql-mmm/mmm_mon.conf</code><br> 配置文件中的 <code>debug</code><br> 的值再次修改为 <code>0</code><br>，关闭<code>debug</code><br> 模式再次重启 monitor 服务。此时查看 monitor 服务的日志内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/# tail -f var/log/mysql-mmm/mmm_mond.log  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_backlog&#x27; on &#x27;slave1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_backlog&#x27; on &#x27;master2&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_threads&#x27; on &#x27;master1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_threads&#x27; on &#x27;slave2&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_threads&#x27; on &#x27;slave1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;rep_threads&#x27; on &#x27;master2&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;ping&#x27; on &#x27;master1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;ping&#x27; on &#x27;slave2&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;ping&#x27; on &#x27;slave1&#x27; is ok!  </span><br><span class="line">2021/02/22 23:42:43 INFO Check &#x27;ping&#x27; on &#x27;master2&#x27; is ok!</span><br></pre></td></tr></table></figure>

<p><strong>问题排查 2：虚拟 IP 不能再各个节点生成？</strong></p>
<p>启动 MMM 后，发现不能通过 VIP 访问 MySQL 数据库，去各个节点使用 <code>ifconfig -a</code><br> 或者 <code>ip addr</code><br> 命令查看发现没有对应的 VIP 生成。查看了各个节点 MMM agent 服务的日志文件<code>/var/log/mysql-mmm/mmm_agent.log</code><br>，发现如下错误信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/# tail -f var/log/mysql-mmm/mmm_agentd.log  </span><br><span class="line">2021/02/23 17:16:19 FATAL Couldn&#x27;t configure IP &#x27;172.20.0.111&#x27; on interface &#x27;eth0&#x27;: undef  </span><br><span class="line">2021/02/23 17:16:19 FATAL Couldn&#x27;t allow writes: undef  </span><br><span class="line">2021/02/23 17:16:22 FATAL Couldn&#x27;t configure IP &#x27;172.20.0.111&#x27; on interface &#x27;eth0&#x27;: undef  </span><br><span class="line">2021/02/23 17:16:22 FATAL Couldn&#x27;t allow writes: undef</span><br></pre></td></tr></table></figure>

<p>经过排查发现是在设置 VIP 的时候失败，设置客户端 VIP 的脚本如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/mysql-mmm/agent/configure_ip</span><br></pre></td></tr></table></figure>

<p>执行上面的脚本发现如下错误：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62316071988900.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62316071988900.png"></a></p>
<p>提示我们，需要在 perl 中安装 arp.pm 包。安装的时候，为了提高速度，我们修改一下 perl 安装模块的时候使用的镜像源。</p>
<p>修改 perl 安装包的时候使用的镜像源，参考如下方式修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/# perl -MCPAN -e shell  </span><br><span class="line">cpan\[5\]&gt; o conf urllist  </span><br><span class="line">urllist  </span><br><span class="line">0 \[http://www.cpan.org/\] </span><br><span class="line">Type &#x27;o conf&#x27; to view all configuration items</span><br><span class="line"></span><br><span class="line">cpan\[6\]&gt; o conf urllist push http://mirrors.aliyun.com/CPAN/  </span><br><span class="line">Please use &#x27;o conf commit&#x27; to make the config permanent!</span><br><span class="line"></span><br><span class="line">cpan\[7\]&gt; o conf commit  </span><br><span class="line">commit: wrote &#x27;/root/.cpan/CPAN/MyConfig.pm&#x27;</span><br><span class="line"></span><br><span class="line">cpan\[8\]&gt; o conf urllist  </span><br><span class="line">urllist  </span><br><span class="line">0 \[http://www.cpan.org/\] </span><br><span class="line">1 \[http://mirrors.aliyun.com/CPAN/\] </span><br><span class="line">Type &#x27;o conf&#x27; to view all configuration items</span><br><span class="line"></span><br><span class="line">cpan\[9\]&gt; install Net::ARP</span><br><span class="line"></span><br><span class="line">cpan\[10\]&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中各个命令的含义如下：</p>
<ul>
<li><p><code>o conf urllist</code><br>：查看的当前的镜像源</p>
</li>
<li><p><code>o conf urllist push http://mirrors.aliyun.com/CPAN/</code><br>：添加阿里的 perl 镜像源</p>
</li>
<li><p><code>o conf commit</code><br>：提交对镜像源的修改</p>
</li>
<li><p><code>install Net::ARP</code><br>：安装 arp.pm 包。</p>
</li>
</ul>
<p>经过上面的安装方式，发现安装失败。于是下载源码自己编译安装这个包。参考如下命令顺序来编译安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载源码文件 </span>  </span><br><span class="line">wget https://cpan.metacpan.org/authors/id/C/CR/CRAZYDJ/Net-ARP-1.0.11.tgz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 解压下载后的文件 </span>  </span><br><span class="line">tar -zxvf Net-ARP-1.0.11.tgz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 进入下载目录 </span>  </span><br><span class="line">cd Net-ARP-1.0.11</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 执行编译 </span>  </span><br><span class="line">perl Makefile.PL</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 执行安装</span>  </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>上面安装 Net-ARP 包的操作，需要在除了 monitor 节点的四个节点上都执行安装一下。</p>
<p>最后所有节点的 IP 地址和 VIP 地址如下所示：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62324916880500.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62324916880500.png"></a></p>
<h3 id="验证 VIP 访问数据库"><a href="# 验证 VIP 访问数据库" class="headerlink" title="验证 VIP 访问数据库"></a>验证 VIP 访问数据库 </h3><p> 当我们的 MMM 客户段服务在四个 MySQL 数据库实例中启动，并且 MMM 监控服务在 monitor 节点启动之后。我们在 monitor 节点上面尝试使用各个 VIP 看能否正常连接到 MySQL 数据库。验证的结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm#  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/ONLINE. Roles: reader(172.20.0.111), writer(172.20.0.100)  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.122)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.211)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.100 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">| master1.mysql |  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.111 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">| master1.mysql |  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.122 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">| master2.mysql |  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.211 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+</span><br><span class="line">-----+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+</span><br><span class="line">-----+  </span><br><span class="line">| slave1.mysql |  </span><br><span class="line">+</span><br><span class="line">-----+  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.222 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+</span><br><span class="line">-----+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+</span><br><span class="line">-----+  </span><br><span class="line">| slave2.mysql |  </span><br><span class="line">+</span><br><span class="line">-----+  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<h3 id="验证 MMM 的高可用"><a href="# 验证 MMM 的高可用" class="headerlink" title="验证 MMM 的高可用"></a>验证 MMM 的高可用 </h3><p> 我们把 master1 节点上面的 MySQL 服务停止掉，来验证一下是否会把主从同步的源头从 master1 切换为 master2 上面，并且我们在 monitor 节点上，仍然可以通过 writer<br>vip 去连接到 MySQL 上。</p>
<p>停止 master1 节点上面的 MySQL 服务，在 master1 节点上，执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@master1:~/Net-ARP-1.0.11# etc/init.d/mysql stop  </span><br><span class="line">............  </span><br><span class="line">\[info\] MySQL Community Server 5.7.31 is stopped.  </span><br><span class="line">root@master1:~/Net-ARP-1.0.11# %   </span><br><span class="line">➜  ~</span><br></pre></td></tr></table></figure>

<p>接着，我们在 monitor 节点上，查看 MMM 监控各个节点服务的状态，发现 master1 节点以及下线了，并且我们的 writer<br>ip，已经从原先的 master1 节点迁移到 master2 节点上了。如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Warning: agent on host master1 is not reachable</span>  </span><br><span class="line">master1(172.20.0.11) master/HARD_OFFLINE. Roles:  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.122), writer(172.20.0.100)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.111), reader(172.20.0.211)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control checks all  </span><br><span class="line">slave2 ping \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave2 mysql \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave2 rep_threads \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave2 rep_backlog \[last change: 2021/02/23 16:19:44\] OK: Backlog is null  </span><br><span class="line">master1 ping \[last change: 2021/02/23 18:44:57\] ERROR: Could not ping 172.20.0.11  </span><br><span class="line">master1 mysql \[last change: 2021/02/23 18:44:40\] ERROR: Connect error (host = 172.20.0.11:3306, user = mmm_monitor)!</span><br><span class="line">Can&#x27;t connect to MySQL server on &#x27;172.20.0.11&#x27; (115)  </span><br><span class="line">master1 rep_threads \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">master1 rep_backlog \[last change: 2021/02/23 16:19:44\] OK: Backlog is null  </span><br><span class="line">slave1 ping \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave1 mysql \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave1 rep_threads \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">slave1 rep_backlog \[last change: 2021/02/23 16:19:44\] OK: Backlog is null  </span><br><span class="line">master2 ping \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">master2 mysql \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">master2 rep_threads \[last change: 2021/02/23 16:19:44\] OK  </span><br><span class="line">master2 rep_backlog \[last change: 2021/02/23 16:19:44\] OK: Backlog is null</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>此时我们看到 master2 上面的 IP 地址信息如下，<code>writer vip 172.20.0.100</code><br>已经迁移到了 master2 主机上了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@master2:~/Net-ARP-1.0.11# ip addr  </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000  </span><br><span class="line">link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00  </span><br><span class="line">inet 127.0.0.1/8 scope host lo  </span><br><span class="line">valid\_lft forever preferred\_lft forever  </span><br><span class="line">2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000  </span><br><span class="line">link/ipip 0.0.0.0 brd 0.0.0.0  </span><br><span class="line">3: ip6tnl0@NONE: &lt;NOARP&gt; mtu 1452 qdisc noop state DOWN group default qlen 1000  </span><br><span class="line">link/tunnel6 :: brd ::  </span><br><span class="line">12: eth0@if13: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default  </span><br><span class="line">link/ether 02:42:ac:14:00:15 brd ff:ff:ff:ff:ff:ff link-netnsid 0  </span><br><span class="line">inet 172.20.0.21/24 brd 172.20.0.255 scope global eth0  </span><br><span class="line">valid\_lft forever preferred\_lft forever  </span><br><span class="line">inet 172.20.0.122/32 scope global eth0  </span><br><span class="line">valid\_lft forever preferred\_lft forever  </span><br><span class="line">inet 172.20.0.100/32 scope global eth0  </span><br><span class="line">valid\_lft forever preferred\_lft forever  </span><br><span class="line">root@master2:~/Net-ARP-1.0.11#</span><br></pre></td></tr></table></figure>

<p>在 monitor 节点上，查看 MMM 的监控服务器的日志信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# tail -20 /var/log/mysql-mmm/mmm_mond.log  </span><br><span class="line">2021/02/23 16:19:49 INFO Check &#x27;mysql&#x27; on &#x27;slave2&#x27; is ok!  </span><br><span class="line">2021/02/23 16:19:49 INFO Check &#x27;mysql&#x27; on &#x27;master1&#x27; is ok!  </span><br><span class="line">2021/02/23 16:19:49 INFO Check &#x27;mysql&#x27; on &#x27;slave1&#x27; is ok!  </span><br><span class="line">2021/02/23 16:19:49 INFO Check &#x27;mysql&#x27; on &#x27;master2&#x27; is ok!  </span><br><span class="line">2021/02/23 18:44:30 WARN Check &#x27;rep_threads&#x27; on &#x27;master1&#x27; is in unknown state! Message: UNKNOWN: Connect error (host =</span><br><span class="line">172.20.0.11:3306, user = mmm_monitor)! Can&#x27;t connect to MySQL server on &#x27;172.20.0.11&#x27; (115)  </span><br><span class="line">2021/02/23 18:44:30 WARN Check &#x27;rep_backlog&#x27; on &#x27;master1&#x27; is in unknown state! Message: UNKNOWN: Connect error (host =</span><br><span class="line">172.20.0.11:3306, user = mmm_monitor)! Can&#x27;t connect to MySQL server on &#x27;172.20.0.11&#x27; (115)  </span><br><span class="line">2021/02/23 18:44:40 ERROR Check &#x27;mysql&#x27; on &#x27;master1&#x27; has failed for 10 seconds! Message: ERROR: Connect error (host =</span><br><span class="line">172.20.0.11:3306, user = mmm_monitor)! Can&#x27;t connect to MySQL server on &#x27;172.20.0.11&#x27; (115)  </span><br><span class="line">2021/02/23 18:44:41 FATAL State of host &#x27;master1&#x27; changed from ONLINE to HARD_OFFLINE (ping: OK, mysql: not OK)  </span><br><span class="line">2021/02/23 18:44:41 INFO Removing all roles from host &#x27;master1&#x27;:  </span><br><span class="line">2021/02/23 18:44:41 INFO Removed role &#x27;reader(172.20.0.111)&#x27; from host &#x27;master1&#x27;  </span><br><span class="line">2021/02/23 18:44:41 INFO Removed role &#x27;writer(172.20.0.100)&#x27; from host &#x27;master1&#x27;  </span><br><span class="line">2021/02/23 18:44:41 FATAL Can&#x27;t reach agent on host &#x27;master1&#x27;  </span><br><span class="line">2021/02/23 18:44:41 ERROR Can&#x27;t send offline status notification to &#x27;master1&#x27; \- killing it!  </span><br><span class="line">2021/02/23 18:44:41 FATAL Could not kill host &#x27;master1&#x27; \- there may be some duplicate ips now! (There&#x27;s no binary</span><br><span class="line">configured for killing hosts.)  </span><br><span class="line">2021/02/23 18:44:41 INFO Orphaned role &#x27;writer(172.20.0.100)&#x27; has been assigned to &#x27;master2&#x27;  </span><br><span class="line">2021/02/23 18:44:41 INFO Orphaned role &#x27;reader(172.20.0.111)&#x27; has been assigned to &#x27;slave1&#x27;  </span><br><span class="line">2021/02/23 18:44:57 ERROR Check &#x27;ping&#x27; on &#x27;master1&#x27; has failed for 11 seconds! Message: ERROR: Could not ping</span><br><span class="line">172.20.0.11  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>我们在 monitor 节点上，再次尝试连接到 <code>writer vip 172.20.0.100</code><br> 上面，发现已经连接到 master2 上面了，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@monitor:/etc/mysql-mmm# mysql -uroot -proot -h172.20.0.100 -e &#x27;select @@hostname&#x27;  </span><br><span class="line">mysql: \[Warning\] Using a password on the command line interface can be insecure.  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">| @@hostname |  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">| master2.mysql |  </span><br><span class="line">+</span><br><span class="line">---+  </span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p>下面我们看一下 slave1 和 slave2 节点主从同步的配置是否，自动切换到 master2 节点上。分别登录到 slave1 和 slave2 节点上执行如下 SQL 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from mysql.slave\_master\_info\\G</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看结果如下：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62340114810300.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62340114810300.png"></a></p>
<p>通过下面的截图，可以看出在新的主节点上面执行的插入数据，是可以正常的同步到两个 slave 从节点上。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62343970188500.png" class="gallery-item"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2023-09-10/62343970188500.png"></a></p>
<p>下面我们把 master1 节点重新启动，让 MySQL 数据库服务恢复。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 master1 容器 </span>  </span><br><span class="line">docker start mysql-ha-mmm-master1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 进入 master1 容器 </span>  </span><br><span class="line">docker exec -it mysql-ha-mmm-master1 /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 启动 master1 上面的 MMM 的 agent 服务</span>  </span><br><span class="line">/etc/init.d/mysql-mmm-agent start</span><br></pre></td></tr></table></figure>

<p>进入 monitor 节点上，查看各个节点的状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 master1 启动后，在 monitor 节点查看各个节点状态的时候，发现已经不再有 <span class="string">&quot;Warning: agent on host master1 is not reachable&quot;</span></span></span><br><span class="line"> 的警告了。  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/AWAITING_RECOVERY. Roles:  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.122), writer(172.20.0.100)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.111), reader(172.20.0.211)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置 master1 节点上线 </span>  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm\_control set\_online master1  </span><br><span class="line">OK: State of &#x27;master1&#x27; changed to ONLINE. Now you can wait some time and check its new roles!</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 再次查看各个节点的状态，发现 master1 已经上线了。但是它此时成立备用的主节点了，并且给他分配了一个 reader VIP 地址。</span>  </span><br><span class="line">root@monitor:/etc/mysql-mmm# mmm_control show  </span><br><span class="line">master1(172.20.0.11) master/ONLINE. Roles: reader(172.20.0.211)  </span><br><span class="line">master2(172.20.0.21) master/ONLINE. Roles: reader(172.20.0.122), writer(172.20.0.100)  </span><br><span class="line">slave1(172.20.0.12) slave/ONLINE. Roles: reader(172.20.0.111)  </span><br><span class="line">slave2(172.20.0.22) slave/ONLINE. Roles: reader(172.20.0.222)</span><br><span class="line"></span><br><span class="line">root@monitor:/etc/mysql-mmm#</span><br></pre></td></tr></table></figure>

<p><strong>MMM 高可用验证结果小结：</strong></p>
<ul>
<li><p>master1 节点宕机之后，master2 节点会接管 master1 的所有任务。</p>
</li>
<li><p>writer VIP 会自动从 master1 上面转移到 master2 上面。</p>
</li>
<li><p>两个从节点 slave1 和 slave2 会自动的把主从同步的链路从 master1 切换到 master2 上面。</p>
</li>
<li><p>如果在 master1 上除了提供写的服务，还提供可读的服务，也就是为其分配了 reader VIP，那么当 master1 宕机后，这个 reader<br>VIP 不会丢失，会被迁移到其他任意一个节点上。</p>
</li>
<li><p>在 master1 重启后，在 monitor 节点通过命令 <code>mmm_control set_online master1</code><br> 设置 master1 节点上线后，master1 节点不会接管现有 master2 的角色，而是作为一个备用主节点集群中提供服务。此时，只有 master2 节点宕机后，master1 节点才会重新成为主节点的角色。</p>
</li>
<li><p>随着 master1 和 master2 节点的宕机和恢复，提供写的 VIP 会在两个节点上来回切换。</p>
</li>
</ul>
<p>对于这个 5 个服务器组成的高可用集群，如果我们担心 MMM 的 monitor 节点是单节点，不是高可用的 monitor 服务，我们可以在选择一台服务器，在上面部署另外一个 monitor 服务，使用 keepalive 组件，保证两个 monitor 服务至少有一个可用。这样就更加完美了。</p>
<h2 id="总结"><a href="# 总结" class="headerlink" title="总结"></a>总结 </h2><p> 上面就是关于 MySQL 高可用架构 -MMM 架构的搭建过程。期间涉及到了 MySQL 主从同步集群的搭建，我们搭建了一个双主双从的集群，然后基于这个集群，又在每一个节点上面编译安装了 MMM 插件，在每一个节点上启动了 MMM 的 agent 服务。还选择了一台服务器，安装 MMM 监控服务。</p>
<p>希望对你有所帮助，后续会分享其他高可用架构搭建的方式。</p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {selector: '.gallery-item'};
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script></div>
				<link rel="stylesheet" type="text/css" href="https://qiniu.techgrow.cn/readmore/dist/hexo.css">
				<script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script>
				<script>
				var isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);
				var isEncrypt = document.getElementById('hexo-blog-encrypt');
				var allowMobile = false;
				if (!isEncrypt && (!isMobile || (isMobile && allowMobile))) {
					try {
						var plugin = new ReadmorePlugin();
						plugin.init({
							"type": "hexo",
							"id": "readmore-container",
							"name": "程序员朱永胜",
							"blogId": "39259-6450029321246-893",
							"qrcode": "https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142242856.jpg",
							"keyword": "1",
							"random": "1",
							"height": "auto",
							"expires": "365",
							"lockToc": "yes",
							"interval": "60",
							"baseUrl": ""
						});
					} catch(e) {
						console.warn("readmore plugin occurred error: " + e.name + " | " + e.message);
					}
				}
				</script>
			</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="index.html" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/aliyun/202308012321669.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/aliyun/202308012321669.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">程序员朱永胜</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.zysicyj.top/mysql_mmm.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.zysicyj.top/mysql_mmm.html')">MySQL 高可用搭建方案之（MMM）</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142337659.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142337659.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142338230.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/blog/202308142338230.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.zysicyj.top/mysql_mmm.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=undefined&amp;url=https://blog.zysicyj.top/mysql_mmm.html&amp;pic=undefined" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.zysicyj.top" target="_blank"></a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"></div><div class="post_share"><div class="social-share" data-image="https://img.xjh.me/random_img.php?return=302&amp;_r_=9da3b2c6-5f60-bdf8-3222-21df063b9b94" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="cd621e01.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.xjh.me/random_img.php?return=302&amp;_r_=bef67a17-58d7-d84c-bbd2-99c2e7531a58" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL 高可用九种方案</div></div></a></div><div class="next-post pull-right"><a href="mysql_mha.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.xjh.me/random_img.php?return=302&amp;_r_=eff06a86-9c10-c650-fed5-7c4637c8197a" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL 高可用搭建方案之（MHA）</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/aliyun/202308012321669.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">程序员朱永胜</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="mailto:zhuyongsheng@xxc99.cn" rel="external nofollow noreferrer" target="_blank" title="fas fa-envelope"></a><a class="social-icon faa-parent animated-hover" href="https://blog.csdn.net/njpkhuan" rel="external nofollow noreferrer" target="_blank" title="fa-solid fa-blog fa-beat"></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/258577429" rel="external nofollow noreferrer" target="_blank" title="fa-brands fa-bilibili"></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://img02.anheyu.com/adminuploads/1/2022/09/11/631ddb7c9b250.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://blog-1253652709.cos.ap-guangzhou.myqcloud.com/tc/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%20MMM"><span class="toc-number">1.1.</span> <span class="toc-text">什么是 MMM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MMM%20%E6%9E%B6%E6%9E%84%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">MMM 架构的优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MMM%20%E6%9E%B6%E6%9E%84%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">MMM 架构的缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E%E7%9A%84%20MySQL%20%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.</span> <span class="toc-text">搭建双主双从的 MySQL 集群 </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%20MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8E%AF%E5%A2%83"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 准备 MySQL 数据库环境 </span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%9B%91%E6%8E%A7%E8%8A%82%E7%82%B9"><span class="toc-number"></span> <span class="toc-text">启动监控节点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7"><span class="toc-number">0.0.1.</span> <span class="toc-text">创建主从同步的数据库用户 </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE%E7%9A%84%E5%90%8C%E6%AD%A5"><span class="toc-number">0.0.2.</span> <span class="toc-text">历史数据的同步 </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E7%BB%84%E4%BB%8E%E5%90%8C%E6%AD%A5"><span class="toc-number">0.0.3.</span> <span class="toc-text">开启组从同步 </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%B8%8E%E4%B8%BB%E7%9A%84%E5%90%8C%E6%AD%A5"><span class="toc-number">0.0.4.</span> <span class="toc-text">配置主与主的同步 </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%20MMM"><span class="toc-number">0.1.</span> <span class="toc-text">安装 MMM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%20apt-get%20%E6%BA%90"><span class="toc-number">0.1.1.</span> <span class="toc-text">修改 apt-get 源 </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%20MMM"><span class="toc-number">0.1.2.</span> <span class="toc-text">下载 MMM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%20MMM"><span class="toc-number">0.1.3.</span> <span class="toc-text">编译安装 MMM</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%20MMM%20%E4%BD%BF%E7%94%A8%E7%9A%84%20MySQL%20%E7%94%A8%E6%88%B7"><span class="toc-number">0.2.</span> <span class="toc-text">创建 MMM 使用的 MySQL 用户 </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%20MMM%20%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">0.3.</span> <span class="toc-text">修改 MMM 的配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%20MMM%20%E6%9C%8D%E5%8A%A1"><span class="toc-number">0.4.</span> <span class="toc-text">启动 MMM 服务 </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%20VIP%20%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">0.5.</span> <span class="toc-text">验证 VIP 访问数据库 </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%20MMM%20%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">0.6.</span> <span class="toc-text">验证 MMM 的高可用 </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">总结 </span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="../post/hexo-githubpages-to-build-a-personal-blog-website-for-free-1vjsyj.html" title="Hexo+GithubPages 免费搭建个人博客网站"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.xjh.me/random_img.php?return=302&amp;_r_=d997e3bd-8928-85c1-57ae-18ccd1c10f1e" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="Hexo+GithubPages 免费搭建个人博客网站"/></a><div class="content"><a class="title" href="../post/hexo-githubpages-to-build-a-personal-blog-website-for-free-1vjsyj.html" title="Hexo+GithubPages 免费搭建个人博客网站">Hexo+GithubPages 免费搭建个人博客网站</a><time datetime="2025-01-17T14:41:41.000Z" title="更新于 2025-01-17 14:41:41">2025-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../648fb133.html" title="今天去看看我姐（老婆）新开的超市"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.xjh.me/random_img.php?return=302&amp;_r_=694655db-5ff4-9507-f01b-0b4a47db9da0" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="今天去看看我姐（老婆）新开的超市"/></a><div class="content"><a class="title" href="../648fb133.html" title="今天去看看我姐（老婆）新开的超市">今天去看看我姐（老婆）新开的超市</a><time datetime="2025-01-17T06:46:22.541Z" title="更新于 2025-01-17 06:46:22">2025-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../c37612c9.html" title="博客优化差不多了"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.xjh.me/random_img.php?return=302&amp;_r_=f61907cf-a6fe-e42e-5a55-e92734bbcadb" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="博客优化差不多了"/></a><div class="content"><a class="title" href="../c37612c9.html" title="博客优化差不多了">博客优化差不多了</a><time datetime="2025-01-17T06:46:22.541Z" title="更新于 2025-01-17 06:46:22">2025-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../today_2023_09.html" title="Today For 2023 年 9 月"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.xjh.me/random_img.php?return=302&amp;_r_=d94c7b47-d8af-071a-84d2-3c3331a747dd" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="Today For 2023 年 9 月"/></a><div class="content"><a class="title" href="../today_2023_09.html" title="Today For 2023 年 9 月">Today For 2023 年 9 月</a><time datetime="2025-01-17T06:46:22.541Z" title="更新于 2025-01-17 06:46:22">2025-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="../cb2b755d.html" title="老婆七夕快乐"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.xjh.me/random_img.php?return=302&amp;_r_=054831de-403a-02ba-13f9-5fb8787a90c3" onerror="this.onerror=null;this.src='../img/404.jpg'" alt="老婆七夕快乐"/></a><div class="content"><a class="title" href="../cb2b755d.html" title="老婆七夕快乐">老婆七夕快乐</a><time datetime="2025-01-17T06:46:22.541Z" title="更新于 2025-01-17 06:46:22">2025-01-17</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><div id="runtimeTextTip"></div></div><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/"><span>苏ICP备2024066768号-1</span></a></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2025 By <a class="footer-bar-link" href="index.html" title="程序员朱永胜" target="_blank">程序员朱永胜</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="archives/" title="archive"><div class="headline">文章</div><div class="length-num">1220</div></a><a href="tags/" title="tag"><div class="headline">标签</div><div class="length-num">901</div></a><a href="categories/" title="category"><div class="headline">分类</div><div class="length-num">14</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" rel="external nofollow noreferrer" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.zysicyj.top/" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2748ef34.jpg" alt="个人主页"/><span class="back-menu-item-text">个人主页</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">写作软件</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://editor.runjs.cool/post?id=demo" title="Mdx"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4296739868700.png" alt="Mdx"/><span class="back-menu-item-text">Mdx</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://openwrite.cn/" title="OpenWrite"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://openwrite.cn/logo.png" alt="OpenWrite"/><span class="back-menu-item-text">OpenWrite</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jetbrains.com/zh-cn/writerside/" title="WriteSide"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="data:image/jpeg;base64,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" alt="WriteSide"/><span class="back-menu-item-text">WriteSide</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">开发工具</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jetbrains.com/zh-cn/idea/" title="idea"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4576710485000.png" alt="idea"/><span class="back-menu-item-text">idea</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jetbrains.com/zh-cn/datagrip/" title="DataGrip"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4604435065400.png" alt="DataGrip"/><span class="back-menu-item-text">DataGrip</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4663369180700.png" title="WebStorm"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4604435065400.png" alt="WebStorm"/><span class="back-menu-item-text">WebStorm</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html" title="微信开发者工具"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4743988475500.png" alt="微信开发者工具"/><span class="back-menu-item-text">微信开发者工具</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html" title="HBuilder"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://www.dcloud.io/hbuilderx.html" alt="HBuilder"/><span class="back-menu-item-text">HBuilder</span></a><a class="back-menu-item" target="_blank" rel="noopener external nofollow noreferrer" href="https://mobaxterm.mobatek.net/" title="MobaXterm"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="http://blog-1253652709.cos.ap-guangzhou.myqcloud.com/pasteimageintomarkdown/2024-07-16/4849682167700.png" alt="MobaXterm"/><span class="back-menu-item-text">MobaXterm</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="index.html"><i class="fas fa-home faa-tada"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-link faa-tada"></i><span> 目录</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="fas fa-archive faa-tada"></i><span> 时间轴</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="fas fa-folder-open faa-tada"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-list faa-tada"></i><span> 清单</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/movies/"><i class="fas fa-video faa-tada"></i><span> 电影</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/books/"><i class="fas fa-book faa-tada"></i><span> 阅读</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/songs/"><i class="fas fa-music faa-tada"></i><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="fa-brands fa-bilibili faa-tada"></i><span> 追番</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/cinemas/"><i class="fa-brands fa-bilibili faa-tada"></i><span> 追剧</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="fas fa-link faa-tada"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/gallery/"><i class="fas fa-solid fa-image faa-tada"></i><span> 相册集</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/love/static/index.html"><i class="fas fa-heart faa-tada"></i><span> Love</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="fa-solid fa-user faa-tada"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="fa-solid  fa-comment faa-tada"></i><span> 闲言碎语</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="js/utils.js"></script><script src="js/main.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("07/01/2023 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 程序员朱永胜 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("07/01/2023 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="js/search/local-search.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>